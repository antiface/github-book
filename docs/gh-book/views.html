<!DOCTYPE html>  <html> <head>   <title>views.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="models.html">                 models.coffee               </a>                                           <a class="source" href="gh-book.html">                 gh-book.coffee               </a>                                           <a class="source" href="auth.html">                 auth.coffee               </a>                                           <a class="source" href="views.html">                 views.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               views.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&#39;underscore&#39;</span>
  <span class="s">&#39;backbone&#39;</span>
  <span class="s">&#39;marionette&#39;</span>
  <span class="s">&#39;bookish/controller&#39;</span>
  <span class="s">&#39;bookish/models&#39;</span>
  <span class="s">&#39;epub/models&#39;</span>
  <span class="s">&#39;bookish/auth&#39;</span>
  <span class="s">&#39;bookish/views&#39;</span>
  <span class="s">&#39;hbs!gh-book/sign-in-out&#39;</span>
  <span class="s">&#39;hbs!gh-book/fork-book-item&#39;</span>
  <span class="s">&#39;css!bookish&#39;</span>
<span class="p">],</span> <span class="nf">(_, Backbone, Marionette, Controller, AtcModels, EpubModels, Auth, Views, SIGN_IN_OUT, FORK_BOOK_ITEM) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h2>Auth View</h2>

<p>The top-right of each page should have either:</p>

<ol>
<li>a Sign-up/Login link if not logged in</li>
<li>a logoff link with the current user name if logged in</li>
</ol>

<p>This view updates when the login state changes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">Views.AuthView = </span><span class="nx">Views</span><span class="p">.</span><span class="nx">AuthView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">SIGN_IN_OUT</span>
    <span class="nv">events: </span><span class="nx">_</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">Views</span><span class="p">.</span><span class="nx">AuthView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">events</span><span class="p">,</span>
      <span class="s">&#39;click #save-settings&#39;</span><span class="o">:</span> <span class="s">&#39;saveSettings&#39;</span>
      <span class="s">&#39;click #fork-book&#39;</span><span class="o">:</span>     <span class="s">&#39;forkBook&#39;</span>
      <span class="s">&#39;click .other-books&#39;</span><span class="o">:</span>   <span class="s">&#39;otherBooks&#39;</span>
    <span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Add the <code>canFork</code> bit to the resulting JSON so the template knows if the
current user is the same as the current <code>repoUser</code> (Do not show the fork button).</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">templateHelpers: </span><span class="o">-&gt;</span>
      <span class="k">return</span> <span class="p">{</span><span class="nv">canFork: </span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;repoUser&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="o">not</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;password&#39;</span><span class="p">)}</span>

    <span class="nv">signIn: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Set the username and password in the <code>Auth</code> model</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@model</span><span class="p">.</span><span class="nx">set</span>
        <span class="nv">id: </span>      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#github-id&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
        <span class="nv">password: </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#github-password&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Clicking on the link will redirect to the logoff page
Before it does, update the model</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">signOut: </span><span class="o">-&gt;</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">signOut</span><span class="p">()</span>

    <span class="nv">forkBook: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Show an alert if the user is not logged in</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">alert</span> <span class="s">&#39;Please log in to fork or just go to the github page and fork the book!&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;id&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Populate the fork modal before showing it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">$fork = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;#fork-book-modal&#39;</span>


      <span class="nv">forkHandler = </span><span class="nf">(org) -&gt;</span> <span class="nf">() -&gt;</span>
        <span class="nx">Auth</span><span class="p">.</span><span class="nx">getRepo</span><span class="p">().</span><span class="nx">fork</span> <span class="nf">(err, resp) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Close the modal dialog</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">$fork</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s">&#39;hide&#39;</span><span class="p">)</span>

          <span class="k">throw</span> <span class="s">&quot;Problem forking: </span><span class="si">#{</span><span class="nx">err</span><span class="si">}</span><span class="s">&quot;</span> <span class="k">if</span> <span class="nx">err</span>

          <span class="nx">setTimeout</span><span class="p">(</span><span class="o">-&gt;</span>
            <span class="nx">Auth</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;repoUser&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">org</span> <span class="o">or</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))</span>
          <span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>

          <span class="nx">alert</span> <span class="s">&#39;Thanks for copying!\nThe current repository (in settings) will be updated to point to your copy of the book. \nThe next time you click Save the changes will be saved to your copied book.\nIf not, refresh the page and change the Repo User in Settings.&#39;</span>


      <span class="nx">Auth</span><span class="p">.</span><span class="nx">getUser</span><span class="p">().</span><span class="nx">orgs</span> <span class="nf">(err, orgs) -&gt;</span>
        <span class="nv">$list = </span><span class="nx">$fork</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.modal-body&#39;</span><span class="p">).</span><span class="nx">empty</span><span class="p">()</span>

        <span class="nv">$item = </span><span class="nx">@$</span><span class="p">(</span><span class="nx">FORK_BOOK_ITEM</span> <span class="p">{</span><span class="nv">login: </span><span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;id&#39;</span><span class="p">})</span>
        <span class="nx">$item</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;button&#39;</span><span class="p">).</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="nx">forkHandler</span><span class="p">(</span><span class="kc">null</span><span class="p">)</span>
        <span class="nx">$list</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$item</span>

        <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">orgs</span><span class="p">,</span> <span class="nf">(org) -&gt;</span>
          <span class="nv">$item = </span><span class="nx">@$</span><span class="p">(</span><span class="nx">FORK_BOOK_ITEM</span> <span class="p">{</span><span class="nv">login: </span><span class="s">&quot;</span><span class="si">#{</span><span class="nx">org</span><span class="p">.</span><span class="nx">login</span><span class="si">}</span><span class="s"> (Organization)&quot;</span><span class="p">})</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>For now disallow forking to organizations.
    $item.find('button').on 'click', forkHandler(org)</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">$item</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;disabled&#39;</span>

          <span class="nx">$list</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$item</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Show the modal</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">$fork</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s">&#39;show&#39;</span><span class="p">)</span>


    <span class="nv">otherBooks: </span><span class="nf">(evt) -&gt;</span>
      <span class="nv">$config = </span><span class="nx">@$</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Add a trailing slash to the root path if one is set</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">rootPath = </span><span class="nx">$config</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;rootPath&#39;</span><span class="p">)</span>
      <span class="nx">rootPath</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span> <span class="k">if</span> <span class="nx">rootPath</span> <span class="o">and</span> <span class="nx">rootPath</span><span class="p">[</span><span class="nx">rootPath</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Close the modal</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">$save = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;#save-settings-modal&#39;</span>
      <span class="nx">$save</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s">&#39;hide&#39;</span><span class="p">)</span>

      <span class="nx">@model</span><span class="p">.</span><span class="nx">set</span>
        <span class="nv">repoUser: </span><span class="nx">$config</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;repoUser&#39;</span><span class="p">)</span>
        <span class="nv">repoName: </span><span class="nx">$config</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;repoName&#39;</span><span class="p">)</span>
        <span class="nv">branch: </span>  <span class="nx">$config</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">)</span>
        <span class="nv">rootPath: </span><span class="nx">rootPath</span>

    <span class="nv">saveSettings: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Add a trailing slash to the root path if one is set</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">rootPath = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#github-rootPath&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
      <span class="nx">rootPath</span> <span class="o">+=</span> <span class="s">&#39;/&#39;</span> <span class="k">if</span> <span class="nx">rootPath</span> <span class="o">and</span> <span class="nx">rootPath</span><span class="p">[</span><span class="nx">rootPath</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Update the repo settings</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@model</span><span class="p">.</span><span class="nx">set</span>
        <span class="nv">repoUser: </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#github-repoUser&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
        <span class="nv">repoName: </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#github-repoName&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
        <span class="nv">branch: </span>  <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#github-branch&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
        <span class="nv">rootPath: </span><span class="nx">rootPath</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 