<!DOCTYPE html>  <html> <head>   <title>models.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="models.html">                 models.coffee               </a>                                           <a class="source" href="gh-book.html">                 gh-book.coffee               </a>                                           <a class="source" href="auth.html">                 auth.coffee               </a>                                           <a class="source" href="views.html">                 views.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               models.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&#39;exports&#39;</span>
  <span class="s">&#39;underscore&#39;</span>
  <span class="s">&#39;backbone&#39;</span>
  <span class="s">&#39;bookish/media-types&#39;</span>
  <span class="s">&#39;bookish/controller&#39;</span>
  <span class="s">&#39;bookish/models&#39;</span>
  <span class="s">&#39;bookish/views&#39;</span>
  <span class="s">&#39;hbs!./opf-file&#39;</span>
  <span class="s">&#39;hbs!./container-file&#39;</span>
  <span class="s">&#39;hbs!./nav-serialize&#39;</span>
<span class="p">],</span> <span class="nf">(exports, _, Backbone, MEDIA_TYPES, Controller, Models, Views, OPF_TEMPLATE, CONTAINER_TEMPLATE, NAV_SERIALIZE) -&gt;</span>

  <span class="nv">BaseCollection = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">DeferrableCollection</span>
  <span class="nv">BaseContent = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">BaseContent</span>
  <span class="nv">BaseBook = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">BaseBook</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Links in a navigation document are relative to where the nav document resides.
If it does not live in the same directory then they need to be resolved to
an absolute path so content Models can be looked up</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">resolvePath = </span><span class="nf">(context, relPath) -&gt;</span>
    <span class="k">return</span> <span class="nx">relPath</span> <span class="k">if</span> <span class="nx">context</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s">&#39;/&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
    <span class="nx">context</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\/[^\/]*$/</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">relPath</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

  <span class="nv">mixin = </span><span class="nf">(src, dest) -&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span> <span class="nx">dest</span><span class="p">,</span> <span class="nx">src</span>


  <span class="nv">TemplatedFileMixin =</span>
    <span class="nv">getterField: </span><span class="o">-&gt;</span> <span class="k">throw</span> <span class="s">&#39;NO GETTER FIELD SET&#39;</span>
    <span class="nv">template: </span><span class="o">-&gt;</span> <span class="k">throw</span> <span class="s">&#39;NO TEMPLATE SET&#39;</span>

    <span class="nv">parse: </span><span class="nf">(xmlStr) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>this method is called either:</p>

<ul>
<li>when reading from a sync (<code>xmlStr</code> is a string of HTML)</li>
<li>during construction (<code>xmlStr</code> is a dictionary of attributes)</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="s">&#39;string&#39;</span> <span class="o">==</span> <span class="k">typeof</span> <span class="nx">xmlStr</span>
        <span class="nv">ret = </span><span class="p">{}</span>
        <span class="nx">ret</span><span class="p">[</span><span class="nx">@getterField</span><span class="p">]</span> <span class="o">=</span> <span class="nx">xmlStr</span>
        <span class="k">return</span> <span class="nx">ret</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nx">xmlStr</span>
    <span class="nv">serialize: </span><span class="o">-&gt;</span> <span class="nx">@template</span> <span class="nx">@toJSON</span><span class="p">()</span>

  <span class="nv">HTMLFile = </span><span class="nx">BaseContent</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">TemplatedFileMixin</span><span class="p">,</span> <span class="p">{</span>
    <span class="nv">mediaType: </span><span class="s">&#39;application/xhtml+xml&#39;</span>
    <span class="nv">getterField: </span><span class="s">&#39;body&#39;</span>
    <span class="nv">serialize: </span><span class="o">-&gt;</span> <span class="nx">@get</span> <span class="nx">@getterField</span>
  <span class="p">}</span>

  <span class="nv">PackageFileMixin = </span><span class="nx">mixin</span> <span class="nx">TemplatedFileMixin</span><span class="p">,</span>
    <span class="nv">defaults: </span><span class="nx">_</span><span class="p">.</span><span class="nx">defaults</span><span class="p">(</span><span class="nx">BaseBook</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">defaults</span><span class="p">,</span>
      <span class="nv">language: </span><span class="s">&#39;en&#39;</span>
      <span class="nv">title: </span><span class="kc">null</span>
      <span class="nv">creator: </span><span class="kc">null</span>
      <span class="nv">created: </span><span class="kc">null</span>
      <span class="nv">modified: </span><span class="kc">null</span>
      <span class="nv">publisher: </span><span class="kc">null</span>
      <span class="nv">copyrightDate: </span><span class="kc">null</span>
    <span class="p">)</span>
    <span class="nv">getterField: </span><span class="s">&#39;content&#39;</span>
    <span class="nv">mediaType: </span><span class="s">&#39;application/vnd.org.cnx.collection&#39;</span>

    <span class="nv">template: </span><span class="nx">OPF_TEMPLATE</span>
    <span class="nv">manifestType: </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Serialize all the spine items</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">toJSON: </span><span class="o">-&gt;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="k">for</span> <span class="nx">model</span> <span class="k">in</span> <span class="nx">@models</span>

    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="nx">BaseBook</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>When the <code>navTreeStr</code> is changed on the package,
CHange it on the navigation.html file</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@listenTo</span> <span class="nx">@navTreeRoot</span><span class="p">,</span> <span class="s">&#39;change:treeNode add:treeNode remove:treeNode&#39;</span><span class="p">,</span> <span class="o">=&gt;</span>

        <span class="nv">$newTree = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">@navModel</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;body&#39;</span><span class="p">)</span>

        <span class="nv">newTree = </span><span class="nx">NAV_SERIALIZE</span> <span class="nx">@navTreeRoot</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
        <span class="nv">$newTree = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">newTree</span><span class="p">)</span>

        <span class="nv">$bodyNodes = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">@navModel</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;body&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>wrap the elements in a div so we can call <code>$.find</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">$body = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s">&#39;&lt;div&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">$bodyNodes</span>

        <span class="nv">$nav = </span><span class="nx">$body</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;nav&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nx">$nav</span>
          <span class="nx">$nav</span><span class="p">.</span><span class="nx">replaceWith</span> <span class="nx">$newTree</span>
        <span class="k">else</span>
          <span class="nx">$body</span><span class="p">.</span><span class="nx">prepend</span> <span class="nx">$nav</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Serialize the body back out to navigation.html</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="s">&#39;html&#39;</span> <span class="o">==</span> <span class="nx">$body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">tagName</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">()</span>
          <span class="nv">bodyStr = </span><span class="nx">$body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">outerHTML</span>
        <span class="k">else</span>
          <span class="k">if</span> <span class="nx">$body</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">1</span>
            <span class="nv">$wrap = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s">&#39;&lt;div&gt;/&lt;div&gt;&#39;</span><span class="p">)</span>
            <span class="nx">$wrap</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$body</span>
            <span class="nv">$body = </span><span class="nx">$wrap</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>TODO: Add <code>&lt;html&gt;&lt;head&gt;...&lt;/head&gt;</code> tags around the <code>$body</code></p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">bodyStr = </span><span class="nx">$body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Set a <code>doNotReparse</code> option so when <code>change:body</code> is fired we do not
need to reparse the body and reset the ToC.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@navModel</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;body&#39;</span><span class="p">,</span> <span class="nx">bodyStr</span><span class="p">,</span> <span class="p">{</span><span class="nx">doNotReparse</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Once the OPF is populated load the navigation HTML file.
Change the model promise to wait for the navigation file to load
before considering the Book Loaded (daisy-chain the navigation file).</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@_promise = </span><span class="nx">@loaded</span><span class="p">().</span><span class="k">then</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Now we know what the navigation HTML file is so go pull it.
Then, this model is loaded and views can stop spinning and waiting</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@navModel</span><span class="p">.</span><span class="nx">loaded</span><span class="p">().</span><span class="k">then</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Finally, we have the Navigation HTML!</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>If its contents changes then so does the navTree</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nx">@navModel</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;change:body&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">xmlStr</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Re-parse the tree and set it as the navTree
<code>parseNavTree</code> is defined in <code>AppModels.Book</code></p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">@_updateNavTreeFromXML</span> <span class="nx">xmlStr</span> <span class="k">if</span> <span class="o">!</span><span class="nx">options</span><span class="p">.</span><span class="nx">doNotReparse</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Give the HTML files in the manifest some titles from navigation.html</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">navTree = </span><span class="nx">@_updateNavTreeFromXML</span><span class="p">(</span><span class="nx">@navModel</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">),</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span><span class="kc">true</span><span class="p">})</span>
          <span class="nv">recSetTitles = </span><span class="p">(</span><span class="nx">nodes</span><span class="o">=</span><span class="p">[])</span> <span class="o">=&gt;</span>
            <span class="k">for</span> <span class="nx">node</span> <span class="k">in</span> <span class="nx">nodes</span>
              <span class="k">if</span> <span class="nx">node</span><span class="p">.</span><span class="nx">id</span> <span class="o">and</span> <span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s">&#39;#&#39;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
                <span class="nv">path = </span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">@navModel</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
                <span class="nv">model = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span> <span class="nx">path</span>
                <span class="nx">model</span><span class="p">.</span><span class="nx">set</span> <span class="p">{</span><span class="nv">title: </span><span class="nx">node</span><span class="p">.</span><span class="nx">title</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Do not mark the object as 'dirty' (for saving)</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">delete</span> <span class="nx">model</span><span class="p">.</span><span class="nx">changed</span>
              <span class="nx">recSetTitles</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">)</span>
          <span class="nx">recSetTitles</span> <span class="nx">navTree</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Finally, this model is completely loaded.
Begin callbacks</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">return</span> <span class="nx">@</span>

    <span class="nv">_updateNavTreeFromXML: </span><span class="nf">(xmlStr, options) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Re-parse the tree and set it as the navTree
<code>parseNavTree</code> is defined in <code>AppModels.Book</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">$xml = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">xmlStr</span><span class="p">)</span>
      <span class="k">return</span> <span class="nx">@trigger</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="s">&#39;Could not parse XML&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">$xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p><code>$xml</code> may contain several top-level elements.
Wrap the <code>$xml</code> with a <code>&lt;div/&gt;</code> so we can call <code>$body.find()</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">$body = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s">&#39;&lt;div&gt;&lt;/div&gt;&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">$xml</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Find the tree and parse it into a JSON object</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">$nav = </span><span class="nx">$body</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;nav&#39;</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&#39;ERROR: Currently only 1 nav element in the navigation document is supported&#39;</span> <span class="k">if</span> <span class="nx">$nav</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="mi">1</span>
      <span class="nv">$nav = </span><span class="nx">$nav</span><span class="p">.</span><span class="nx">first</span><span class="p">()</span>

      <span class="nv">navTree = </span><span class="nx">@parseNavTree</span><span class="p">(</span><span class="nx">$nav</span><span class="p">).</span><span class="nx">children</span>
      <span class="nx">@navTreeRoot</span><span class="p">.</span><span class="nx">reset</span> <span class="nx">navTree</span>
      <span class="k">return</span> <span class="nx">navTree</span>

    <span class="nv">parse: </span><span class="nf">(xmlStr) -&gt;</span>
      <span class="k">return</span> <span class="nx">xmlStr</span> <span class="k">if</span> <span class="s">&#39;string&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">xmlStr</span>
      <span class="nv">$xml = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">parseXML</span> <span class="nx">xmlStr</span><span class="p">)</span>

      <span class="vi">@manifest = </span><span class="k">new</span> <span class="nx">@manifestType</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@manifest</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>If we were unable to parse the XML then trigger an error</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="s">&#39;INVALID_OPF&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">$xml</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>For the structure of the TOC file see <code>OPF_TEMPLATE</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">bookId = </span><span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="si">#{</span><span class="nx">$xml</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;unique-identifier&#39;</span><span class="si">}</span><span class="s">&quot;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span>

      <span class="nv">title = </span><span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>The manifest contains all the items in the spine
but the spine element says which order they are in</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;package &gt; manifest &gt; item&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">item</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">$item = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">item</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Add it to the set of all content and construct the correct model based on the mimetype</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">mediaType = </span><span class="nx">$item</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;media-type&#39;</span>
        <span class="nv">path = </span><span class="nx">$item</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;href&#39;</span>
        <span class="nv">ContentType = </span><span class="nx">MEDIA_TYPES</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">mediaType</span><span class="p">).</span><span class="nx">constructor</span>
        <span class="nv">model = </span><span class="k">new</span> <span class="nx">ContentType</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Set the path to the file to be relative to the OPF file</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">id: </span><span class="nx">resolvePath</span><span class="p">(</span><span class="nx">@id</span><span class="p">,</span> <span class="nx">path</span><span class="p">)</span>
          <span class="nv">properties: </span><span class="nx">$item</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;properties&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>if We could not find a suitable editor for the <code>mediaType</code> make sure
we do not lose that information when saving out the OPF file.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">model.mediaType = </span><span class="nx">mediaType</span> <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="nx">mediaType</span> <span class="k">in</span> <span class="nx">MEDIA_TYPES</span><span class="p">.</span><span class="nx">list</span><span class="p">())</span>

        <span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">add</span> <span class="nx">model</span>
        <span class="nx">@manifest</span><span class="p">.</span><span class="nx">add</span> <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>If we stumbled upon the special navigation document
then remember it.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="s">&#39;nav&#39;</span> <span class="o">==</span> <span class="nx">$item</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;properties&#39;</span><span class="p">)</span>
          <span class="vi">@navModel = </span><span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Ignore the spine because it is defined by the navTree in EPUB3.
<strong>TODO:</strong> Fall back on <code>toc.ncx</code> and then the <code>spine</code> to create a navTree if one does not exist</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="p">{</span><span class="nv">title: </span><span class="nx">title</span><span class="p">,</span> <span class="nv">bookId: </span><span class="nx">bookId</span><span class="p">}</span>

    <span class="nv">toJSON: </span><span class="o">-&gt;</span>
      <span class="nv">json = </span><span class="nx">BaseBook</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="nv">json.manifest = </span><span class="nx">@manifest</span><span class="o">?</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Loop through everything in the manifest and add a <code>mediaType</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">json</span><span class="p">.</span><span class="nx">manifest</span><span class="p">,</span> <span class="nf">(item) -&gt;</span>
        <span class="nv">item.mediaType = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="p">).</span><span class="nx">mediaType</span>

      <span class="nx">json</span>

  <span class="nv">PackageFile = </span><span class="nx">BaseBook</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">PackageFileMixin</span>




  <span class="nv">EPUBContainer = </span><span class="nx">BaseCollection</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">CONTAINER_TEMPLATE</span>
    <span class="nv">model: </span><span class="nx">PackageFile</span>
    <span class="nv">defaults:</span>
      <span class="nv">urlRoot: </span><span class="s">&#39;&#39;</span>
    <span class="nv">url: </span><span class="o">-&gt;</span> <span class="s">&#39;META-INF/container.xml&#39;</span>

    <span class="nv">toJSON: </span><span class="o">-&gt;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="k">for</span> <span class="nx">model</span> <span class="k">in</span> <span class="nx">@models</span>
    <span class="nv">parse: </span><span class="nf">(xmlStr) -&gt;</span>
      <span class="nv">$xml = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">xmlStr</span><span class="p">)</span>
      <span class="nv">ret = </span><span class="p">[]</span>
      <span class="nx">$xml</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;rootfiles &gt; rootfile&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">href = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">).</span><span class="nx">attr</span> <span class="s">&#39;full-path&#39;</span>
        <span class="nx">ret</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">href</span><span class="p">}</span>
      <span class="k">return</span> <span class="nx">ret</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Add the <code>HTMLFile</code> and <code>PackageFile</code> to the media types registry.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">MEDIA_TYPES</span><span class="p">.</span><span class="nx">add</span> <span class="s">&#39;application/xhtml+xml&#39;</span><span class="p">,</span>
    <span class="nv">constructor: </span><span class="nx">HTMLFile</span>
    <span class="nv">editAction: </span><span class="nx">Controller</span><span class="p">.</span><span class="nx">editContent</span>

  <span class="nx">MEDIA_TYPES</span><span class="p">.</span><span class="nx">add</span> <span class="s">&#39;application/vnd.org.cnx.collection&#39;</span><span class="p">,</span>
    <span class="nv">constructor: </span><span class="nx">PackageFile</span>
    <span class="nv">editAction: </span><span class="nx">Controller</span><span class="p">.</span><span class="nx">editBook</span>
    <span class="nv">accepts:</span>
      <span class="s">&#39;application/xhtml+xml&#39;</span><span class="o">:</span> <span class="nf">(book, model) -&gt;</span>
        <span class="nx">book</span><span class="p">.</span><span class="nx">prependNewContent</span> <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Override the default <code>mediaType</code> for new content in the Book edit view.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">Views.BookEditView::contentMediaType = </span><span class="s">&#39;application/xhtml+xml&#39;</span>

  <span class="nv">exports.EPUB_CONTAINER = </span><span class="k">new</span> <span class="nx">EPUBContainer</span><span class="p">()</span>

  <span class="k">return</span> <span class="nx">exports</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 