<!DOCTYPE html>  <html> <head>   <title>gh-book.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="models.html">                 models.coffee               </a>                                           <a class="source" href="gh-book.html">                 gh-book.coffee               </a>                                           <a class="source" href="auth.html">                 auth.coffee               </a>                                           <a class="source" href="views.html">                 views.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               gh-book.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&#39;underscore&#39;</span>
  <span class="s">&#39;backbone&#39;</span>
  <span class="s">&#39;bookish/media-types&#39;</span>
  <span class="s">&#39;bookish/controller&#39;</span>
  <span class="s">&#39;bookish/models&#39;</span>
  <span class="s">&#39;epub/models&#39;</span>
  <span class="s">&#39;bookish/auth&#39;</span>
  <span class="s">&#39;gh-book/views&#39;</span>
  <span class="s">&#39;css!bookish&#39;</span>
<span class="p">],</span> <span class="nf">(_, Backbone, MEDIA_TYPES, Controller, AtcModels, EpubModels, Auth, Views) -&gt;</span>

  <span class="nv">DEBUG = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Generate UUIDv4 id's (from http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">uuid = b = </span><span class="nf">(a) -&gt;</span>
    <span class="p">(</span><span class="k">if</span> <span class="nx">a</span> <span class="k">then</span> <span class="p">(</span><span class="nx">a</span> <span class="o">^</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">16</span> <span class="o">&gt;&gt;</span> <span class="nx">a</span> <span class="o">/</span> <span class="mi">4</span><span class="p">).</span><span class="nx">toString</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span> <span class="k">else</span> <span class="p">([</span><span class="mi">1</span><span class="nx">e7</span><span class="p">]</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="nx">e3</span> <span class="o">+</span> <span class="o">-</span><span class="mi">4</span><span class="nx">e3</span> <span class="o">+</span> <span class="o">-</span><span class="mi">8</span><span class="nx">e3</span> <span class="o">+</span> <span class="o">-</span><span class="mi">1</span><span class="nx">e11</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/[018]/g</span><span class="p">,</span> <span class="nx">b</span><span class="p">))</span>



  <span class="nv">writeFile = </span><span class="nf">(path, text, commitText) -&gt;</span>
    <span class="nx">Auth</span><span class="p">.</span><span class="nx">getRepo</span><span class="p">().</span><span class="nx">write</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">),</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;rootPath&#39;</span><span class="p">)</span><span class="si">}#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="nx">text</span><span class="p">,</span> <span class="nx">commitText</span>

  <span class="nv">readFile = </span>      <span class="nf">(path) -&gt;</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">getRepo</span><span class="p">().</span><span class="nx">read</span>       <span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">),</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;rootPath&#39;</span><span class="p">)</span><span class="si">}#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nv">readBinaryFile = </span><span class="nf">(path) -&gt;</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">getRepo</span><span class="p">().</span><span class="nx">readBinary</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">),</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;rootPath&#39;</span><span class="p">)</span><span class="si">}#{</span><span class="nx">path</span><span class="si">}</span><span class="s">&quot;</span>
  <span class="nv">readDir = </span>       <span class="nf">(path) -&gt;</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">getRepo</span><span class="p">().</span><span class="nx">contents</span>   <span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">),</span> <span class="nx">path</span>




  <span class="nv">Backbone.sync = </span><span class="nf">(method, model, options) -&gt;</span>

    <span class="nv">path = </span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span> <span class="o">or</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span><span class="o">?</span><span class="p">()</span> <span class="o">or</span> <span class="nx">model</span><span class="p">.</span><span class="nx">url</span>

    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">method</span><span class="p">,</span> <span class="nx">path</span> <span class="k">if</span> <span class="nx">DEBUG</span>
    <span class="nv">ret = </span><span class="kc">null</span>
    <span class="k">switch</span> <span class="nx">method</span>
      <span class="k">when</span> <span class="s">&#39;read&#39;</span> <span class="k">then</span> <span class="nv">ret = </span><span class="nx">readFile</span><span class="p">(</span><span class="nx">path</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;update&#39;</span> <span class="k">then</span> <span class="nv">ret = </span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">serialize</span><span class="p">(),</span> <span class="s">&#39;Editor Save&#39;</span><span class="p">)</span>
      <span class="k">when</span> <span class="s">&#39;create&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Create an id if this model has not been saved yet</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">id = </span><span class="nx">_uuid</span><span class="p">()</span>
        <span class="nx">model</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nx">id</span>
        <span class="nv">ret = </span><span class="nx">writeFile</span><span class="p">(</span><span class="nx">path</span><span class="p">,</span> <span class="nx">model</span><span class="p">.</span><span class="nx">serialize</span><span class="p">())</span>
      <span class="k">else</span> <span class="k">throw</span> <span class="s">&quot;Model sync method not supported: </span><span class="si">#{</span><span class="nx">method</span><span class="si">}</span><span class="s">&quot;</span>

    <span class="nx">ret</span><span class="p">.</span><span class="nx">done</span> <span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">success</span><span class="o">?</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
    <span class="nx">ret</span><span class="p">.</span><span class="nx">fail</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">error</span><span class="o">?</span><span class="p">(</span><span class="nx">ret</span><span class="p">,</span> <span class="nx">error</span><span class="p">)</span>
    <span class="k">return</span> <span class="nx">ret</span>



  <span class="nx">EpubModels</span><span class="p">.</span><span class="nx">EPUB_CONTAINER</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nf">(model) -&gt;</span>
    <span class="nv">url = </span><span class="s">&quot;https://github.com/</span><span class="si">#{</span><span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;repoUser&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;repoName&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">/tree/</span><span class="si">#{</span><span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;branch&#39;</span><span class="p">)</span><span class="si">}</span><span class="s">/</span><span class="si">#{</span><span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;rootPath&#39;</span><span class="p">)</span><span class="si">}#{</span><span class="nx">model</span><span class="p">.</span><span class="nx">url</span><span class="p">()</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nx">alert</span> <span class="s">&quot;There was a problem getting </span><span class="si">#{</span><span class="nx">url</span><span class="si">}</span><span class="s">\nPlease check your settings and try again.&quot;</span>

  <span class="nv">resetDesktop = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Clear out all the content and reset <code>EPUB_CONTAINER</code> so it is always fetched</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">AtcModels</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
    <span class="nx">EpubModels</span><span class="p">.</span><span class="nx">EPUB_CONTAINER</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
    <span class="nv">EpubModels.EPUB_CONTAINER._promise = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Begin listening to route changes
and load the initial views based on the URL.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="o">not</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">History</span><span class="p">.</span><span class="nx">started</span>
      <span class="nx">Controller</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
    <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s">&#39;workspace&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Change how the workspace is loaded (from <code>META-INF/content.xml</code>)</p>

<p><code>EPUB_CONTAINER</code> will fill in the workspace just by requesting files</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">EpubModels</span><span class="p">.</span><span class="nx">EPUB_CONTAINER</span><span class="p">.</span><span class="nx">loaded</span><span class="p">().</span><span class="k">then</span> <span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>fetch all the book contents so the workspace is populated</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">EpubModels</span><span class="p">.</span><span class="nx">EPUB_CONTAINER</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(book) -&gt;</span> <span class="nx">book</span><span class="p">.</span><span class="nx">loaded</span><span class="p">()</span>


  <span class="nv">XhtmlModel = </span><span class="nx">AtcModels</span><span class="p">.</span><span class="nx">BaseContent</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">mediaType: </span><span class="s">&#39;application/xhtml+xml&#39;</span>

    <span class="nv">parse: </span><span class="nf">(html) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>The result of a Github PUT is an object instead of the new state of the model.
Basically ignore it.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="p">{}</span> <span class="k">if</span> <span class="s">&#39;string&#39;</span> <span class="o">!=</span> <span class="k">typeof</span> <span class="nx">html</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Rename elements before jQuery parses and removes them
(because they are not valid children of a div)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">html = </span><span class="s">&quot;&lt;body&gt;</span><span class="si">#{</span><span class="nx">html</span><span class="si">}</span><span class="s">&lt;/body&gt;&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="sr">/&lt;body/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">html</span>
      <span class="nv">html = </span><span class="s">&quot;&lt;html&gt;</span><span class="si">#{</span><span class="nx">html</span><span class="si">}</span><span class="s">&lt;/html&gt;&quot;</span> <span class="k">if</span> <span class="o">not</span> <span class="sr">/&lt;html/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">html</span>

      <span class="nv">html = </span><span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/html&gt;/g</span><span class="p">,</span> <span class="s">&quot;prefix-html&gt;&quot;</span><span class="p">)</span>
      <span class="nv">html = </span><span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;\/head&gt;/g</span><span class="p">,</span> <span class="s">&quot;&lt;/prefix-head&gt;&quot;</span><span class="p">)</span>
      <span class="nv">html = </span><span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/body&gt;/g</span><span class="p">,</span> <span class="s">&quot;prefix-body&gt;&quot;</span><span class="p">)</span>

      <span class="nv">html = </span><span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;html/g</span><span class="p">,</span> <span class="s">&quot;&lt;prefix-html&quot;</span><span class="p">)</span>
      <span class="nv">html = </span><span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;head&gt;/g</span><span class="p">,</span> <span class="s">&quot;&lt;prefix-head&gt;&quot;</span><span class="p">)</span>
      <span class="nv">html = </span><span class="nx">html</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/&lt;body/g</span><span class="p">,</span> <span class="s">&quot;&lt;prefix-body&quot;</span><span class="p">)</span>

      <span class="nv">$html = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">html</span><span class="p">)</span>

      <span class="nv">$head = </span><span class="nx">$html</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;prefix-head&#39;</span><span class="p">)</span>
      <span class="nv">$body = </span><span class="nx">$html</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;prefix-body&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Change the <code>src</code> attribute to be a <code>data-src</code> attribute if the URL is relative</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">$html</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;img&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(i, img) -&gt;</span>
        <span class="nv">$img = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>
        <span class="nv">src = </span><span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;src&#39;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="sr">/^https?:/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">src</span>
        <span class="k">return</span> <span class="k">if</span> <span class="sr">/^data:/</span><span class="p">.</span><span class="nx">test</span> <span class="nx">src</span>

        <span class="nx">$img</span><span class="p">.</span><span class="nx">removeAttr</span> <span class="s">&#39;src&#39;</span>
        <span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;data-src&#39;</span><span class="p">,</span> <span class="nx">src</span>


      <span class="nv">$images = </span><span class="nx">$html</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;img[data-src]&#39;</span><span class="p">)</span>
      <span class="nv">counter = </span><span class="nx">$images</span><span class="p">.</span><span class="nx">length</span>

      <span class="nx">$images</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">img</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">$img = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>
        <span class="nv">src = </span><span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;data-src&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Load the image file somehow (see below for my github.js changes)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">doneLoading = </span><span class="nx">readBinaryFile</span><span class="p">(</span><span class="nx">src</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">done</span> <span class="p">(</span><span class="nx">bytes</span><span class="p">,</span> <span class="nx">statusMessage</span><span class="p">,</span> <span class="nx">xhr</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Grab the mediaType from the response header (or look in the EPUB3 OPF file)</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">mediaType = </span><span class="nx">AtcModels</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">src</span><span class="p">).</span><span class="nx">mediaType</span> <span class="c1"># xhr.getResponseHeader(&#39;Content-Type&#39;).split(&#39;;&#39;)[0]</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Use the browser's Base64 encode if available</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">encode = </span><span class="nx">btoa</span> <span class="o">or</span> <span class="nx">@Base64</span><span class="o">?</span><span class="p">.</span><span class="nx">encode</span>

          <span class="nv">encoded = </span><span class="nx">encode</span><span class="p">(</span><span class="nx">bytes</span><span class="p">)</span>
          <span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="s">&quot;data:</span><span class="si">#{</span><span class="nx">mediaType</span><span class="si">}</span><span class="s">;base64,</span><span class="si">#{</span><span class="nx">encoded</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span>

          <span class="nx">counter</span><span class="o">--</span>
          <span class="nx">@set</span> <span class="s">&#39;body&#39;</span><span class="p">,</span> <span class="nx">$body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span> <span class="k">if</span> <span class="nx">counter</span> <span class="o">==</span> <span class="mi">0</span>

        <span class="p">.</span><span class="nx">fail</span> <span class="o">-&gt;</span>
          <span class="nx">counter</span><span class="o">--</span>
          <span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="s">&#39;path/to/failure.png&#39;</span><span class="p">)</span>

      <span class="k">return</span> <span class="p">{</span><span class="nv">head: </span><span class="nx">$head</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">,</span> <span class="nv">body: </span><span class="nx">$body</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">innerHTML</span><span class="p">}</span>


    <span class="nv">serialize: </span><span class="o">-&gt;</span>
      <span class="nv">head = </span><span class="nx">@get</span> <span class="s">&#39;head&#39;</span>
      <span class="nv">body = </span><span class="nx">@get</span> <span class="s">&#39;body&#39;</span>
      <span class="nv">$head = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s">&quot;&lt;div class=&#39;unwrap-me&#39;&gt;</span><span class="si">#{</span><span class="nx">head</span><span class="si">}</span><span class="s">&lt;/div&gt;&quot;</span><span class="p">)</span>
      <span class="nv">$body = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s">&quot;&lt;div class=&#39;unwrap-me&#39;&gt;</span><span class="si">#{</span><span class="nx">body</span><span class="si">}</span><span class="s">&lt;/div&gt;&quot;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Replace all the <code>img[data-src]</code> attributes with <code>img[src]</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">$body</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;img[data-src]&#39;</span><span class="p">).</span><span class="nx">each</span> <span class="nf">(i, img) -&gt;</span>
        <span class="nv">$img = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">img</span><span class="p">)</span>
        <span class="nv">src = </span><span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;data-src&#39;</span><span class="p">)</span>
        <span class="nx">$img</span><span class="p">.</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s">&#39;data-src&#39;</span><span class="p">)</span>
        <span class="nx">$img</span><span class="p">.</span><span class="nx">attr</span> <span class="s">&#39;src&#39;</span><span class="p">,</span> <span class="nx">src</span>

      <span class="k">return</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        &lt;html&gt;</span>
<span class="s">          &lt;head&gt;</span>
<span class="s">            </span><span class="si">#{</span><span class="nx">$head</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span><span class="si">}</span><span class="s"></span>
<span class="s">          &lt;/head&gt;</span>
<span class="s">          &lt;body&gt;</span>
<span class="s">            </span><span class="si">#{</span><span class="nx">$body</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">innerHTML</span><span class="si">}</span><span class="s"></span>
<span class="s">          &lt;/body&gt;</span>
<span class="s">        &lt;/html&gt;</span>
<span class="s">        &quot;&quot;&quot;</span>

  <span class="nx">MEDIA_TYPES</span><span class="p">.</span><span class="nx">add</span> <span class="nx">XhtmlModel</span><span class="o">::</span><span class="nx">mediaType</span><span class="p">,</span> <span class="p">{</span><span class="nv">constructor: </span><span class="nx">XhtmlModel</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Clear everything and refetch when the</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">STORED_KEYS = </span><span class="p">[</span><span class="s">&#39;repoUser&#39;</span><span class="p">,</span> <span class="s">&#39;repoName&#39;</span><span class="p">,</span> <span class="s">&#39;branch&#39;</span><span class="p">,</span> <span class="s">&#39;rootPath&#39;</span><span class="p">,</span> <span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="s">&#39;password&#39;</span><span class="p">]</span>
  <span class="nx">Auth</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span>
    <span class="k">if</span> <span class="o">not</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isEmpty</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">pick</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">changed</span><span class="p">,</span> <span class="nx">STORED_KEYS</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>If the user changed login state then don't reset the desktop</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="k">if</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;rateRemaining&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;password&#39;</span><span class="p">)</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">previousAttributes</span><span class="p">()[</span><span class="s">&#39;password&#39;</span><span class="p">]</span>

      <span class="nx">resetDesktop</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Update session storage</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">for</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">Auth</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
        <span class="nx">@sessionStorage</span><span class="o">?</span><span class="p">.</span><span class="nx">setItem</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Auth.on 'change:repoName', resetDesktop
Auth.on 'change:branch', resetDesktop
Auth.on 'change:rootPath', resetDesktop</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Load up the workspace and show the signin modal dialog</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="k">if</span> <span class="o">not</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">History</span><span class="p">.</span><span class="nx">started</span>
    <span class="nx">Controller</span><span class="p">.</span><span class="nx">start</span><span class="p">()</span>
  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">history</span><span class="p">.</span><span class="nx">navigate</span><span class="p">(</span><span class="s">&#39;workspace&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Load from sessionStorage</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">props = </span><span class="p">{}</span>
  <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">STORED_KEYS</span><span class="p">,</span> <span class="nf">(key) -&gt;</span>
    <span class="nv">value = </span><span class="nx">@sessionStorage</span><span class="o">?</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">key</span>
    <span class="nx">props</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span> <span class="k">if</span> <span class="nx">value</span>
  <span class="nx">Auth</span><span class="p">.</span><span class="nx">set</span> <span class="nx">props</span>

  <span class="nv">$signin = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s">&#39;#sign-in-modal&#39;</span><span class="p">)</span>
  <span class="nx">$signin</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s">&#39;show&#39;</span><span class="p">)</span>
  <span class="nx">$signin</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;hide&#39;</span><span class="p">,</span> <span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Delay so we have a chance to save the login/password if the user clicked "Sign In"</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">setTimeout</span> <span class="nx">resetDesktop</span><span class="p">,</span> <span class="mi">100</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 