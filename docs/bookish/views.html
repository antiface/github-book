<!DOCTYPE html>  <html> <head>   <title>views.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="atc.html">                 atc.coffee               </a>                                           <a class="source" href="bookish.html">                 bookish.coffee               </a>                                           <a class="source" href="auth.html">                 auth.coffee               </a>                                           <a class="source" href="controller.html">                 controller.coffee               </a>                                           <a class="source" href="languages.html">                 languages.coffee               </a>                                           <a class="source" href="media-types.html">                 media-types.coffee               </a>                                           <a class="source" href="models.html">                 models.coffee               </a>                                           <a class="source" href="strings.html">                 strings.coffee               </a>                                           <a class="source" href="views.html">                 views.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               views.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>Backbone Views</h1>

<p>Most views have the following properties:</p>

<ol>
<li>Load a Handlebar template using the <code>hbs</code> plugin (see <code>define</code> below)</li>
<li>Attach listeners to the corresponding model (see <code>initialize</code> method and <code>events:</code>)</li>
<li>Attach jQuery listeners to the rendered template (see <code>onRender</code> methods)</li>
<li>Navigate to a different "page" (see <code>Controller.*</code> in the <code>jQuery.on</code> handlers)</li>
</ol>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>                            </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&#39;exports&#39;</span>
  <span class="s">&#39;underscore&#39;</span>
  <span class="s">&#39;backbone&#39;</span>
  <span class="s">&#39;marionette&#39;</span>
  <span class="s">&#39;jquery&#39;</span>
  <span class="s">&#39;aloha&#39;</span>
  <span class="s">&#39;bookish/controller&#39;</span>
  <span class="s">&#39;bookish/models&#39;</span>
  <span class="s">&#39;bookish/media-types&#39;</span>
  <span class="s">&#39;./languages&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Load the Handlebar templates</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="s">&#39;hbs!bookish/views/content-edit&#39;</span>
  <span class="s">&#39;hbs!bookish/views/search-box&#39;</span>
  <span class="s">&#39;hbs!bookish/views/search-results&#39;</span>
  <span class="s">&#39;hbs!bookish/views/search-results-item&#39;</span>
  <span class="s">&#39;hbs!bookish/views/dnd-handle&#39;</span>
  <span class="s">&#39;hbs!bookish/views/modal-wrapper&#39;</span>
  <span class="s">&#39;hbs!bookish/views/edit-metadata&#39;</span>
  <span class="s">&#39;hbs!bookish/views/edit-roles&#39;</span>
  <span class="s">&#39;hbs!bookish/views/language-variants&#39;</span>
  <span class="s">&#39;hbs!bookish/views/aloha-toolbar&#39;</span>
  <span class="s">&#39;hbs!bookish/views/sign-in-out&#39;</span>
  <span class="s">&#39;hbs!bookish/views/book-edit&#39;</span>
  <span class="s">&#39;hbs!bookish/views/book-edit-node&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Load internationalized strings</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="s">&#39;i18n!bookish/nls/strings&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p><code>bootstrap</code> and <code>select2</code> add to jQuery and don't export anything of their own
so they are 'defined' <em>after</em> everything else</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="s">&#39;bootstrap&#39;</span>
  <span class="s">&#39;select2&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Include CSS icons used by the toolbar</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="s">&#39;css!font-awesome&#39;</span>
<span class="p">],</span> <span class="nf">(exports, _, Backbone, Marionette, jQuery, Aloha, Controller, Models, MEDIA_TYPES, Languages, CONTENT_EDIT, SEARCH_BOX, SEARCH_RESULT, SEARCH_RESULT_ITEM, DND_HANDLE, DIALOG_WRAPPER, EDIT_METADATA, EDIT_ROLES, LANGUAGE_VARIANTS, ALOHA_TOOLBAR, SIGN_IN_OUT, BOOK_EDIT, BOOK_EDIT_NODE, __) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Drag and Drop Behavior</h2>

<p>Several views allow content to be dragged around.
Each item that is draggable <strong>must</strong> contain 3 DOM attributes:</p>

<ul>
<li><code>data-content-id</code>:    The unique id of the piece of content (it can be a path)</li>
<li><code>data-media-type</code>:    The mime-type of the content being dragged</li>
<li><code>data-content-title</code>: A  human-readable title for the content</li>
</ul>

<p>In addition it may contain the following attributes:</p>

<ul>
<li><code>data-drag-operation="copy"</code>: Specifies the CSS to add a "+" when dragging
                            hinting that the element will not be removed.
                            (For example, content in a search result)</li>
</ul>

<p>Additionally, each draggable element should not contain any text children
so CSS can hide children and properly style the cloned element that is being dragged.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_EnableContentDragging = </span><span class="nf">($els) -&gt;</span>
    <span class="nx">$els</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(i, el) -&gt;</span>
      <span class="nv">$el = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span>
      <span class="nx">$el</span><span class="p">.</span><span class="nx">draggable</span>
        <span class="nv">addClasses: </span><span class="kc">false</span>
        <span class="nv">revert: </span><span class="s">&#39;invalid&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Ensure the handle is on top (zindex) and not bound to be constrained inside a div visually</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">appendTo: </span><span class="s">&#39;body&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Place the little handle right next to the mouse</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">cursorAt:</span>
          <span class="nv">top: </span><span class="mi">0</span>
          <span class="nv">left: </span><span class="mi">0</span>
        <span class="nv">helper: </span><span class="nf">(evt) -&gt;</span>
          <span class="nv">title = </span><span class="nx">$el</span><span class="p">.</span><span class="nx">data</span> <span class="s">&#39;content-title&#39;</span>
          <span class="nv">shortTitle = </span><span class="nx">title</span>
          <span class="nv">shortTitle = </span><span class="nx">title</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;...&#39;</span> <span class="k">if</span> <span class="nx">title</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">20</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Generate the handle div using a template</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">$handle = </span><span class="nx">jQuery</span> <span class="nx">DND_HANDLE</span>
            <span class="nv">id: </span><span class="nx">$el</span><span class="p">.</span><span class="nx">data</span> <span class="s">&#39;content-id&#39;</span>
            <span class="nv">mediaType: </span><span class="nx">$el</span><span class="p">.</span><span class="nx">data</span> <span class="s">&#39;media-type&#39;</span>
            <span class="nv">title: </span><span class="nx">title</span>
            <span class="nv">shortTitle: </span><span class="nx">shortTitle</span>
          <span class="k">return</span> <span class="nx">$handle</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p><strong>FIXME:</strong> Move this delay into a common module so the mock AJAX code can use them too</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">DELAY_BEFORE_SAVING = </span><span class="mi">3000</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Select2 is a multiselect UI library.
It queries the webserver to provide search results as you type</p>

<p>Given a <code>url</code> to query (like <code>/users</code> or <code>/keywords</code>) this returns a config
used when binding select2 to an input.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">SELECT2_AJAX_HANDLER = </span><span class="nf">(url) -&gt;</span>
    <span class="nv">quietMillis: </span><span class="mi">500</span>
    <span class="nv">url: </span><span class="nx">url</span>
    <span class="nv">dataType: </span><span class="s">&#39;json&#39;</span>
    <span class="nv">data: </span><span class="nf">(term, page) -&gt;</span>
      <span class="nv">q: </span><span class="nx">term</span> <span class="c1"># search term</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>parse the results into the format expected by Select2</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">results: </span><span class="nf">(data, page) -&gt;</span>
      <span class="k">return</span> <span class="p">{</span>
        <span class="nv">results: </span><span class="p">({</span><span class="nx">id</span><span class="o">:</span><span class="nx">id</span><span class="p">,</span> <span class="nx">text</span><span class="o">:</span><span class="nx">id</span><span class="p">}</span> <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Make a multiselect widget sortable using jQueryUI.
Unfortunately jQueryUI is not available until Aloha finishes loading
so postpone making it sortable until <code>Aloha.ready</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">SELECT2_MAKE_SORTABLE = </span><span class="nf">($el) -&gt;</span>
    <span class="nx">Aloha</span><span class="p">.</span><span class="nx">ready</span> <span class="o">-&gt;</span>
      <span class="nx">$el</span><span class="p">.</span><span class="nx">select2</span><span class="p">(</span><span class="s">&#39;container&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;ul.select2-choices&#39;</span><span class="p">)</span>
      <span class="p">.</span><span class="nx">sortable</span>
        <span class="nv">cursor: </span><span class="s">&#39;move&#39;</span>
        <span class="nv">containment: </span><span class="s">&#39;parent&#39;</span>
        <span class="nv">start: </span><span class="o">-&gt;</span>  <span class="nx">$el</span><span class="p">.</span><span class="nx">select2</span> <span class="s">&#39;onSortStart&#39;</span>
        <span class="nv">update: </span><span class="o">-&gt;</span> <span class="nx">$el</span><span class="p">.</span><span class="nx">select2</span> <span class="s">&#39;onSortEnd&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p><strong>FIXME:</strong> Move these subjects to a common module so the mock code can use them and can be used elsewhere</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">METADATA_SUBJECTS = </span><span class="p">[</span><span class="s">&#39;Arts&#39;</span><span class="p">,</span> <span class="s">&#39;Mathematics and Statistics&#39;</span><span class="p">,</span> <span class="s">&#39;Business&#39;</span><span class="p">,</span>
    <span class="s">&#39;Science and Technology&#39;</span><span class="p">,</span> <span class="s">&#39;Humanities&#39;</span><span class="p">,</span> <span class="s">&#39;Social Sciences&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>Given the language list in <a href="languages.html">languages.coffee</a>
this reorganizes them so they can be shown in a dropdown.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">LANGUAGES = </span><span class="p">[{</span><span class="nv">code: </span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nv">native: </span><span class="s">&#39;&#39;</span><span class="p">,</span> <span class="nv">english: </span><span class="s">&#39;&#39;</span><span class="p">}]</span>
  <span class="k">for</span> <span class="nx">languageCode</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">Languages</span><span class="p">.</span><span class="nx">getLanguages</span><span class="p">()</span>
    <span class="nv">value = </span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">({},</span> <span class="nx">value</span><span class="p">)</span>  <span class="c1"># Clone the value.</span>
    <span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="p">{</span><span class="nv">code: </span><span class="nx">languageCode</span><span class="p">})</span>
    <span class="nx">LANGUAGES</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h2>Search Result Views (workspace)</h2>

<p>A list of search results (stubs of models only containing an icon, url, title)
need a generic view for an item.</p>

<p>Since we don't really distinguish between a search result view and a workspace/collection/etc
just consider them the same.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.SearchResultsItemView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">tagName: </span><span class="s">&#39;tr&#39;</span>
    <span class="nv">template: </span><span class="nx">SEARCH_RESULT_ITEM</span>
    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span>
    <span class="nv">onRender: </span><span class="o">-&gt;</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">Controller</span><span class="p">.</span><span class="nx">editModel</span><span class="p">(</span><span class="nx">@model</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Add DnD options to content</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">$content = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s">&#39;*[data-media-type]&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Since we use jqueryui's draggable which is loaded when Aloha loads
delay until Aloha is finished loading</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Aloha</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=&gt;</span>

        <span class="nx">_EnableContentDragging</span><span class="p">(</span><span class="nx">$content</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Figure out which mediaTypes can be dropped onto each element</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">$content</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">i</span><span class="p">,</span> <span class="nx">el</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nv">$el = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">el</span><span class="p">)</span>
          <span class="nv">validSelectors = </span><span class="p">[]</span>
          <span class="nv">mediaType = </span><span class="nx">MEDIA_TYPES</span><span class="p">.</span><span class="nx">get</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">mediaType</span>
          <span class="k">for</span> <span class="nx">acceptsType</span> <span class="k">in</span> <span class="nx">_</span><span class="p">.</span><span class="nx">keys</span> <span class="nx">mediaType</span><span class="o">?</span><span class="p">.</span><span class="nx">accepts</span> <span class="o">or</span> <span class="p">{}</span>
            <span class="nx">validSelectors</span><span class="p">.</span><span class="nx">push</span> <span class="s">&quot;*[data-media-type=\&quot;</span><span class="si">#{</span><span class="nx">acceptsType</span><span class="si">}</span><span class="s">\&quot;]&quot;</span>

          <span class="nv">validSelectors = </span><span class="nx">validSelectors</span><span class="p">.</span><span class="nx">join</span> <span class="s">&#39;,&#39;</span>

          <span class="k">if</span> <span class="nx">validSelectors</span>
            <span class="nx">$el</span><span class="p">.</span><span class="nx">droppable</span>
              <span class="nv">greedy: </span><span class="kc">true</span>
              <span class="nv">addClasses: </span><span class="kc">false</span>
              <span class="nv">accept: </span><span class="nx">validSelectors</span>
              <span class="nv">activeClass: </span><span class="s">&#39;editor-drop-zone-active&#39;</span>
              <span class="nv">hoverClass: </span><span class="s">&#39;editor-drop-zone-hover&#39;</span>
              <span class="nv">drop: </span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">ui</span><span class="p">)</span> <span class="o">=&gt;</span>
                <span class="nv">$drag = </span><span class="nx">ui</span><span class="p">.</span><span class="nx">draggable</span>
                <span class="nv">$drop = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Find the model representing the id that was dragged</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">model = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span> <span class="nx">$drag</span><span class="p">.</span><span class="nx">data</span> <span class="s">&#39;content-id&#39;</span>
                <span class="nv">drop = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span> <span class="nx">$drop</span><span class="p">.</span><span class="nx">data</span> <span class="s">&#39;content-id&#39;</span>
                <span class="nx">mediaType</span><span class="p">.</span><span class="nx">accepts</span><span class="p">[</span><span class="nx">model</span><span class="p">.</span><span class="nx">mediaType</span><span class="p">](</span><span class="nx">drop</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Add the hasChanged bit to the resulting JSON so the template can render an asterisk
if this piece of content has unsaved changes</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">templateHelpers: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Figure out if the model was just fetched (all the changed attributes used to be 'undefined')
or if the attributes did actually change</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Delete any properties that were null before</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">changes = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">changedAttributes</span><span class="p">()</span> <span class="o">or</span> <span class="p">{}</span>
      <span class="p">(</span><span class="k">delete</span> <span class="nx">changes</span><span class="p">[</span><span class="nx">attribute</span><span class="p">]</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">previous</span><span class="p">(</span><span class="nx">attribute</span><span class="p">))</span> <span class="k">for</span> <span class="nx">attribute</span> <span class="k">of</span> <span class="nx">changes</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>If there was anything that was actually changed (not null before) then mark the save button.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">return</span> <span class="p">{</span><span class="nv">hasChanged: </span><span class="nx">_</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">changes</span><span class="p">).</span><span class="nx">length</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>This can also be thought of as the Workspace view</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.SearchResultsView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">CompositeView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">SEARCH_RESULT</span>
    <span class="nv">itemViewContainer: </span><span class="s">&#39;tbody&#39;</span>
    <span class="nv">itemView: </span><span class="nx">exports</span><span class="p">.</span><span class="nx">SearchResultsItemView</span>

    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="nx">@listenTo</span> <span class="nx">@collection</span><span class="p">,</span> <span class="s">&#39;reset&#39;</span><span class="p">,</span>   <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span>
      <span class="nx">@listenTo</span> <span class="nx">@collection</span><span class="p">,</span> <span class="s">&#39;add&#39;</span><span class="p">,</span>     <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span>
      <span class="nx">@listenTo</span> <span class="nx">@collection</span><span class="p">,</span> <span class="s">&#39;remove&#39;</span><span class="p">,</span>  <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>The search box. Changing the text will cause the underlying collection to filter
and fire off <code>add/remove</code> events.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.SearchBoxView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">SEARCH_BOX</span>
    <span class="nv">events:</span>
      <span class="s">&#39;keyup #search&#39;</span><span class="o">:</span> <span class="s">&#39;setFilter&#39;</span>
      <span class="s">&#39;change #search&#39;</span><span class="o">:</span> <span class="s">&#39;setFilter&#39;</span>
    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="k">throw</span> <span class="s">&#39;BUG: You must wrap the collection in a FilterableCollection&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">setFilter</span>
    <span class="nv">setFilter: </span><span class="nf">(evt) -&gt;</span>
      <span class="nv">$searchBox = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">@$el</span><span class="p">).</span><span class="nx">find</span> <span class="s">&#39;#search&#39;</span>
      <span class="nv">filterStr = </span><span class="nx">$searchBox</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
      <span class="nv">filterStr = </span><span class="s">&#39;&#39;</span> <span class="k">if</span> <span class="nx">filterStr</span><span class="p">.</span><span class="nx">length</span> <span class="o">&lt;</span> <span class="mi">2</span>
      <span class="nx">@model</span><span class="p">.</span><span class="nx">setFilter</span> <span class="nx">filterStr</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>A generic way of editing a HTML key in a model using the Aloha Editor</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.AlohaEditView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p><strong>NOTE:</strong> This template is not wrapped in an element</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">template: </span><span class="nf">() -&gt;</span> <span class="k">throw</span> <span class="s">&#39;You need to specify a template, modelKey, and optionally alohaOptions&#39;</span>
    <span class="nv">modelKey: </span><span class="kc">null</span>
    <span class="nv">alohaOptions: </span><span class="kc">null</span>

    <span class="nv">initialize: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Update the view when the content is done loading (remove progress bar)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;change:_done&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span>

      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span> <span class="s">&quot;change:</span><span class="si">#{</span><span class="nx">@modelKey</span><span class="si">}</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">value</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">return</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">internalAlohaUpdate</span>

        <span class="nv">alohaId = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Sometimes Aloha hasn't loaded up yet</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">alohaId</span> <span class="o">and</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">parents</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
          <span class="nv">alohaEditable = </span><span class="nx">Aloha</span><span class="p">.</span><span class="nx">getEditableById</span><span class="p">(</span><span class="nx">alohaId</span><span class="p">)</span>
          <span class="nv">editableBody = </span><span class="nx">alohaEditable</span><span class="p">.</span><span class="nx">getContents</span><span class="p">()</span>
          <span class="nx">alohaEditable</span><span class="p">.</span><span class="nx">setContents</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="k">if</span> <span class="nx">value</span> <span class="o">!=</span> <span class="nx">editableBody</span>
        <span class="k">else</span>
          <span class="nx">@$el</span><span class="p">.</span><span class="nx">empty</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>

    <span class="nv">onRender: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Wait until Aloha is started before loading MathJax.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">MathJax</span><span class="o">?</span><span class="p">.</span><span class="nx">Hub</span><span class="p">.</span><span class="nx">Configured</span><span class="p">()</span>

      <span class="k">if</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;_done&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Once Aloha has finished loading enable</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">)</span>
        <span class="nx">Aloha</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=&gt;</span>
          <span class="nx">@$el</span><span class="p">.</span><span class="nx">aloha</span><span class="p">(</span><span class="nx">@alohaOptions</span><span class="p">)</span>
          <span class="nx">@$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Auto save after the user has stopped making changes</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">updateModelAndSave = </span><span class="o">=&gt;</span>
          <span class="nv">alohaId = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Sometimes Aloha hasn't loaded up yet
Only save when the editable has changed</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">if</span> <span class="nx">alohaId</span>
            <span class="nv">alohaEditable = </span><span class="nx">Aloha</span><span class="p">.</span><span class="nx">getEditableById</span><span class="p">(</span><span class="nx">alohaId</span><span class="p">)</span>
            <span class="nv">editableBody = </span><span class="nx">alohaEditable</span><span class="p">.</span><span class="nx">getContents</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Change the contents but do not update the Aloha editable area</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">@model</span><span class="p">.</span><span class="nx">set</span> <span class="nx">@modelKey</span><span class="p">,</span> <span class="nx">editableBody</span><span class="p">,</span> <span class="p">{</span><span class="nv">internalAlohaUpdate: </span><span class="kc">true</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Grr, the <code>aloha-smart-content-changed</code> can only be listened to globally
(via <code>Aloha.bind</code>) instead of on each editable.</p>

<p>This is problematic when we have multiple Aloha editors on a page.
Instead, autosave after some period of inactivity.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@$el</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;blur&#39;</span><span class="p">,</span> <span class="nx">updateModelAndSave</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h2>Edit Content Body</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.ContentEditView = </span><span class="nx">exports</span><span class="p">.</span><span class="nx">AlohaEditView</span><span class="p">.</span><span class="nx">extend</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p><strong>NOTE:</strong> This template is not wrapped in an element</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">template: </span><span class="nx">CONTENT_EDIT</span>
    <span class="nv">modelKey: </span><span class="s">&#39;body&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Edit the title field of a piece of Content</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.TitleEditView = </span><span class="nx">exports</span><span class="p">.</span><span class="nx">AlohaEditView</span><span class="p">.</span><span class="nx">extend</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p><strong>NOTE:</strong> This template is not wrapped in an element</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">template: </span><span class="nf">(serialized_model) -&gt;</span> <span class="s">&quot;</span><span class="si">#{</span><span class="nx">serialized_model</span><span class="p">.</span><span class="nx">title</span> <span class="o">or</span> <span class="s">&#39;Untitled&#39;</span><span class="si">}</span><span class="s">&quot;</span>
    <span class="nv">modelKey: </span><span class="s">&#39;title&#39;</span>
    <span class="nv">tagName: </span><span class="s">&#39;span&#39;</span> <span class="c1"># override the default tagName of `div` so titles can be edited inline.</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Parse in (from handlebars) the Aloha Toolbar and buttons</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.ContentToolbarView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">ALOHA_TOOLBAR</span>

    <span class="nv">onRender: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>Wait until Aloha is started before enabling the toolbar</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$el</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">)</span>
      <span class="nx">Aloha</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=&gt;</span>
        <span class="nx">@$el</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h2>Content Metadata</h2>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.MetadataEditView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">EDIT_METADATA</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Bind methods onto jQuery events that happen in the view</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">events:</span>
      <span class="s">&#39;change *[name=language]&#39;</span><span class="o">:</span> <span class="s">&#39;_updateLanguageVariant&#39;</span>

    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;change:language&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@_updateLanguage</span><span class="p">()</span>
      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;change:subjects&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@_updateSubjects</span><span class="p">()</span>
      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;change:keywords&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@_updateKeywords</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>Update the UI when the language changes.
Also called during initial render</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_updateLanguage: </span><span class="nf">() -&gt;</span>
      <span class="nv">language = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
      <span class="p">[</span><span class="nx">lang</span><span class="p">]</span> <span class="o">=</span> <span class="nx">language</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;*[name=language]&quot;</span><span class="p">).</span><span class="nx">select2</span><span class="p">(</span><span class="s">&#39;val&#39;</span><span class="p">,</span> <span class="nx">lang</span><span class="p">)</span>
      <span class="nx">@_updateLanguageVariant</span><span class="p">()</span>

    <span class="nv">_updateLanguageVariant: </span><span class="nf">() -&gt;</span>
      <span class="nv">$language = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=language]&#39;</span><span class="p">)</span>
      <span class="nv">language = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;language&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
      <span class="p">[</span><span class="nx">lang</span><span class="p">,</span> <span class="nx">variant</span><span class="p">]</span> <span class="o">=</span> <span class="nx">language</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;-&#39;</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">$language</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span> <span class="o">!=</span> <span class="nx">lang</span>
        <span class="nv">lang = </span><span class="nx">$language</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
        <span class="nv">variant = </span><span class="kc">null</span>
      <span class="nv">$variant = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=variantLanguage]&#39;</span><span class="p">)</span>
      <span class="nv">$label = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[for=variantLanguage]&#39;</span><span class="p">)</span>
      <span class="nv">variants = </span><span class="p">[]</span>
      <span class="k">for</span> <span class="nx">code</span><span class="p">,</span> <span class="nx">value</span> <span class="k">of</span> <span class="nx">Languages</span><span class="p">.</span><span class="nx">getCombined</span><span class="p">()</span>
        <span class="k">if</span> <span class="nx">code</span><span class="p">[..</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">lang</span>
          <span class="nx">jQuery</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="nx">value</span><span class="p">,</span> <span class="p">{</span><span class="nv">code: </span><span class="nx">code</span><span class="p">})</span>
          <span class="nx">variants</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">variants</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Generate the language variants dropdown.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">$variant</span><span class="p">.</span><span class="nx">removeAttr</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">)</span>
        <span class="nx">$variant</span><span class="p">.</span><span class="nx">html</span><span class="p">(</span><span class="nx">LANGUAGE_VARIANTS</span><span class="p">(</span><span class="s">&#39;variants&#39;</span><span class="o">:</span> <span class="nx">variants</span><span class="p">))</span>
        <span class="nx">$variant</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;option[value=</span><span class="si">#{</span><span class="nx">language</span><span class="si">}</span><span class="s">]&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;selected&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="nx">$label</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;hidden&#39;</span><span class="p">)</span>
        <span class="nx">$variant</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;hidden&#39;</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">$variant</span><span class="p">.</span><span class="nx">empty</span><span class="p">().</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">,</span> <span class="kc">true</span><span class="p">)</span>
        <span class="nx">$variant</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;hidden&#39;</span><span class="p">)</span>
        <span class="nx">$label</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;hidden&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Helper method to populate a multiselect input</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_updateSelect2: </span><span class="nf">(key) -&gt;</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&quot;*[name=</span><span class="si">#{</span><span class="nx">key</span><span class="si">}</span><span class="s">]&quot;</span><span class="p">).</span><span class="nx">select2</span><span class="p">(</span><span class="s">&#39;val&#39;</span><span class="p">,</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span> <span class="nx">key</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>Update the View with new subjects selected</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_updateSubjects: </span><span class="o">-&gt;</span> <span class="nx">@_updateSelect2</span> <span class="s">&#39;subjects&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Update the View with new keywords selected</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_updateKeywords: </span><span class="o">-&gt;</span> <span class="nx">@_updateSelect2</span> <span class="s">&#39;keywords&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>Populate some of the dropdowns like language and subjects.
Also, initialize the select2 widget on elements</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">onRender: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>Populate the Language dropdown and Subjects checkboxes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">$languages = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=language]&#39;</span><span class="p">)</span>
      <span class="k">for</span> <span class="nx">lang</span> <span class="k">in</span> <span class="nx">LANGUAGES</span>
        <span class="nv">$lang = </span><span class="nx">jQuery</span><span class="p">(</span><span class="s">&#39;&lt;option&gt;&lt;/option&gt;&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;value&#39;</span><span class="p">,</span> <span class="nx">lang</span><span class="p">.</span><span class="nx">code</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">lang</span><span class="p">.</span><span class="nx">native</span><span class="p">)</span>
        <span class="nx">$languages</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">$lang</span><span class="p">)</span>

      <span class="nx">$languages</span><span class="p">.</span><span class="nx">select2</span>
        <span class="nv">placeholder: </span><span class="nx">__</span><span class="p">(</span><span class="s">&#39;Select a language&#39;</span><span class="p">)</span>

      <span class="nv">$subjects = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=subjects]&#39;</span><span class="p">)</span>
      <span class="nx">$subjects</span><span class="p">.</span><span class="nx">select2</span>
        <span class="nv">tags: </span><span class="nx">METADATA_SUBJECTS</span>
        <span class="nv">tokenSeparators: </span><span class="p">[</span><span class="s">&#39;,&#39;</span><span class="p">]</span>
        <span class="nv">separator: </span><span class="s">&#39;|&#39;</span> <span class="c1"># String used to delimit ids in $(&#39;input&#39;).val()</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Enable multiselect on certain elements</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">$keywords = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=keywords]&#39;</span><span class="p">)</span>
      <span class="nx">$keywords</span><span class="p">.</span><span class="nx">select2</span>
        <span class="nv">tags: </span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;keywords&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="p">[]</span>
        <span class="nv">tokenSeparators: </span><span class="p">[</span><span class="s">&#39;,&#39;</span><span class="p">]</span>
        <span class="nv">separator: </span><span class="s">&#39;|&#39;</span> <span class="c1"># String used to delimit ids in $(&#39;input&#39;).val()</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>ajax: SELECT2<em>AJAX</em>HANDLER(URLS.KEYWORDS)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">initSelection: </span><span class="nf">(element, callback) -&gt;</span>
          <span class="nv">data = </span><span class="p">[]</span>
          <span class="nx">_</span><span class="p">.</span><span class="nx">each</span> <span class="nx">element</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">),</span> <span class="nf">(str) -&gt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">push</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">str</span><span class="p">,</span> <span class="nv">text: </span><span class="nx">str</span><span class="p">}</span>
          <span class="nx">callback</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Select the correct language (Handlebars can't do that)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@_updateLanguage</span><span class="p">()</span>
      <span class="nx">@_updateSubjects</span><span class="p">()</span>
      <span class="nx">@_updateKeywords</span><span class="p">()</span>

      <span class="nx">@delegateEvents</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>This is used by <code>DialogWrapper</code> which offers a "Save" and "Cancel" buttons</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">attrsToSave: </span><span class="nf">() -&gt;</span>
      <span class="nv">language = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=language]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
      <span class="nv">variant = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=variantLanguage]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">()</span>
      <span class="nv">language = </span><span class="nx">variant</span> <span class="o">or</span> <span class="nx">language</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>subjects could be the empty string in which case it would be set to <code>[""]</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">subjects = </span><span class="p">(</span><span class="nx">kw</span> <span class="k">for</span> <span class="nx">kw</span> <span class="k">in</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=subjects]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">))</span>
      <span class="nv">subjects = </span><span class="p">[]</span> <span class="k">if</span> <span class="s">&#39;&#39;</span> <span class="o">is</span> <span class="nx">subjects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Keywords could be the empty string in which case it would be set to <code>[""]</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">keywords = </span><span class="p">(</span><span class="nx">kw</span> <span class="k">for</span> <span class="nx">kw</span> <span class="k">in</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=keywords]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">))</span>
      <span class="nv">keywords = </span><span class="p">[]</span> <span class="k">if</span> <span class="s">&#39;&#39;</span> <span class="o">is</span> <span class="nx">keywords</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

      <span class="k">return</span> <span class="p">{</span>
        <span class="nv">language: </span><span class="nx">language</span>
        <span class="nv">subjects: </span><span class="nx">subjects</span>
        <span class="nv">keywords: </span><span class="nx">keywords</span>
      <span class="p">}</span>


  <span class="nv">exports.RolesEditView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">EDIT_ROLES</span>

    <span class="nv">onRender: </span><span class="o">-&gt;</span>
      <span class="nv">$authors = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=authors]&#39;</span><span class="p">)</span>
      <span class="nv">$copyrightHolders = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=copyrightHolders]&#39;</span><span class="p">)</span>

      <span class="nx">$authors</span><span class="p">.</span><span class="nx">select2</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p><strong>FIXME:</strong> The authors should be looked up instead of being arbitrary text</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">tags: </span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="p">[]</span>
        <span class="nv">tokenSeparators: </span><span class="p">[</span><span class="s">&#39;,&#39;</span><span class="p">]</span>
        <span class="nv">separator: </span><span class="s">&#39;|&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>ajax: SELECT2<em>AJAX</em>HANDLER(URLS.USERS)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">$copyrightHolders</span><span class="p">.</span><span class="nx">select2</span>
        <span class="nv">tags: </span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;copyrightHolders&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="p">[]</span>
        <span class="nv">tokenSeparators: </span><span class="p">[</span><span class="s">&#39;,&#39;</span><span class="p">]</span>
        <span class="nv">separator: </span><span class="s">&#39;|&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>ajax: SELECT2<em>AJAX</em>HANDLER(URLS.USERS)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">SELECT2_MAKE_SORTABLE</span> <span class="nx">$authors</span>
      <span class="nx">SELECT2_MAKE_SORTABLE</span> <span class="nx">$copyrightHolders</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Populate the multiselect widgets with data from the backbone model</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@_updateAuthors</span><span class="p">()</span>
      <span class="nx">@_updateCopyrightHolders</span><span class="p">()</span>

      <span class="nx">@delegateEvents</span><span class="p">()</span>

    <span class="nv">_updateAuthors: </span><span class="o">-&gt;</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=authors]&#39;</span><span class="p">).</span><span class="nx">select2</span> <span class="s">&#39;val&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;authors&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="p">[])</span>
    <span class="nv">_updateCopyrightHolders: </span><span class="o">-&gt;</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=copyrightHolders]&#39;</span><span class="p">).</span><span class="nx">select2</span> <span class="s">&#39;val&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;copyrightHolders&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="p">[])</span>

    <span class="nv">attrsToSave: </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Grab the authors from the multiselect input element.
They are separated with a <code>|</code> character defined when select2 was configured</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">authors = </span><span class="p">(</span><span class="nx">kw</span> <span class="k">for</span> <span class="nx">kw</span> <span class="k">in</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=authors]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">))</span>
      <span class="nv">copyrightHolders = </span><span class="p">(</span><span class="nx">kw</span> <span class="k">for</span> <span class="nx">kw</span> <span class="k">in</span> <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[name=copyrightHolders]&#39;</span><span class="p">).</span><span class="nx">val</span><span class="p">().</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;|&#39;</span><span class="p">))</span>

      <span class="k">return</span> <span class="p">{</span>
        <span class="nv">authors: </span><span class="nx">authors</span>
        <span class="nv">copyrightHolders: </span><span class="nx">copyrightHolders</span>
      <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <h2>Dialog Wrapper</h2>

<p>This class wraps a view in a div and only causes changes when
the 'Save' button is clicked.</p>

<p>Looks like phil came to the same conclusion as the author of Marionette
(Don't make a Bootstrap Modal in a <code>Backbone.View</code>):
[http://lostechies.com/derickbailey/2012/04/17/managing-a-modal-dialog-with-backbone-and-marionette/]</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.DialogWrapper = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">DIALOG_WRAPPER</span>
    <span class="nv">onRender: </span><span class="o">-&gt;</span>
      <span class="nx">@options</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">render</span><span class="p">()</span>
      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.dialog-body&#39;</span><span class="p">).</span><span class="nx">append</span> <span class="nx">@options</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">$el</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Fire a cancel event when the cancel button is pressed</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$el</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="s">&#39;.cancel&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@trigger</span> <span class="s">&#39;cancelled&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <p>Trigger the <code>model.save</code> when the save button is clicked
using the attributes from <code>@options.view.attrsToSave()</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$el</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="s">&#39;.save&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">evt</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">()</span>
        <span class="nv">attrs = </span><span class="nx">@options</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">attrsToSave</span><span class="p">()</span>

        <span class="nx">@options</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span> <span class="nx">attrs</span><span class="p">,</span>
          <span class="nv">success: </span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <p>Trigger a 'sync' because if 'success' is provided 'sync' is not triggered</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">@options</span><span class="p">.</span><span class="nx">view</span><span class="p">.</span><span class="nx">model</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s">&#39;sync&#39;</span><span class="p">)</span>
            <span class="nx">@trigger</span> <span class="s">&#39;saved&#39;</span>

          <span class="nv">error: </span><span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">alert</span><span class="p">(</span><span class="s">&#39;Something went wrong when saving: &#39;</span> <span class="o">+</span> <span class="nx">res</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h2>Default Auth View</h2>

<p>The top-right of each page should have either:</p>

<ol>
<li>a Sign-up/Login link if not logged in</li>
<li>a logoff link with the current user name if logged in</li>
</ol>

<p>This view updates when the login state changes</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.AuthView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">ItemView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">SIGN_IN_OUT</span>
    <span class="nv">events:</span>
      <span class="s">&#39;click #sign-in&#39;</span><span class="o">:</span>       <span class="s">&#39;signIn&#39;</span>
      <span class="s">&#39;click #sign-out&#39;</span><span class="o">:</span>      <span class="s">&#39;signOut&#39;</span>
      <span class="s">&#39;click #save-content&#39;</span><span class="o">:</span>  <span class="s">&#39;saveContent&#39;</span>

    <span class="nv">initialize: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <p>Bind a function to the window if the user tries to navigate away from this page</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">beforeUnload = </span><span class="o">=&gt;</span>
        <span class="k">return</span> <span class="s">&#39;You have unsaved changes. Are you sure you want to leave this page?&#39;</span> <span class="k">if</span> <span class="nx">@hasChanged</span>
      <span class="nx">jQuery</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="kc">on</span> <span class="s">&#39;beforeunload&#39;</span><span class="p">,</span> <span class="nx">beforeUnload</span>

      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span>
      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;change:userid&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <p>Listen to all changes made on Content so we can update the save button</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@listenTo</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">,</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <p>Figure out if the model was just fetched (all the changed attributes used to be 'undefined')
or if the attributes did actually change</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">$save = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;#save-content&#39;</span>
        <span class="nv">checkIfContentActuallyChanged = </span><span class="o">=&gt;</span>
          <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">hasChanged</span><span class="p">()</span>
            <span class="vi">@hasChanged = </span><span class="kc">true</span>
            <span class="nx">$save</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">)</span>
            <span class="nx">$save</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;btn-primary&#39;</span><span class="p">)</span>

        <span class="nx">setTimeout</span> <span class="p">(</span><span class="o">=&gt;</span> <span class="nx">checkIfContentActuallyChanged</span><span class="p">()),</span> <span class="mi">100</span>

      <span class="nx">@listenTo</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">,</span> <span class="s">&#39;change:treeNode add:treeNode remove:treeNode&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span><span class="nx">c</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="vi">@hasChanged = </span><span class="kc">true</span>
        <span class="nv">$save = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;#save-content&#39;</span>
        <span class="nx">$save</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">)</span>
        <span class="nx">$save</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;btn-primary&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <p>If the repo changes and all of the content is reset, update the button</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">disableSave = </span><span class="o">=&gt;</span>
        <span class="vi">@hasChanged = </span><span class="kc">false</span>
        <span class="nv">$save = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span> <span class="s">&#39;#save-content&#39;</span>
        <span class="nx">$save</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;disabled&#39;</span><span class="p">)</span>
        <span class="nx">$save</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;btn-primary&#39;</span><span class="p">)</span>

      <span class="nx">@listenTo</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">,</span> <span class="s">&#39;sync&#39;</span><span class="p">,</span> <span class="nx">disableSave</span>
      <span class="nx">@listenTo</span> <span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">,</span> <span class="s">&#39;reset&#39;</span><span class="p">,</span> <span class="nx">disableSave</span></pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <p>Listen to model changes</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span>

    <span class="nv">onRender: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <p>Enable tooltips</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;*[title]&#39;</span><span class="p">).</span><span class="nx">tooltip</span><span class="p">()</span>

    <span class="nv">signIn: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <p>The browser will go to the login page because <code>#sign-in</code> is a link</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <p>Clicking on the link will redirect to the logoff page
Before it does, update the model</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">signOut: </span><span class="o">-&gt;</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">signOut</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <p>Save each model in sequence.
<strong>FIXME:</strong> This should be done in a commit batch</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">saveContent: </span><span class="o">-&gt;</span>
      <span class="k">return</span> <span class="nx">alert</span> <span class="s">&#39;You need to Sign In (and make sure you can edit) before you can save changes&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;id&#39;</span>
      <span class="nv">$save = </span><span class="nx">@$el</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;#save-progress-modal&#39;</span><span class="p">)</span>
      <span class="nv">$saving     = </span><span class="nx">$save</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.saving&#39;</span><span class="p">)</span>
      <span class="nv">$alertError = </span><span class="nx">$save</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.alert-error&#39;</span><span class="p">)</span>
      <span class="nv">$successBar = </span><span class="nx">$save</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.progress &gt; .bar.success&#39;</span><span class="p">)</span>
      <span class="nv">$errorBar   = </span><span class="nx">$save</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.progress &gt; .bar.error&#39;</span><span class="p">)</span>
      <span class="nv">$label = </span><span class="nx">$save</span><span class="p">.</span><span class="nx">find</span><span class="p">(</span><span class="s">&#39;.label&#39;</span><span class="p">)</span>

      <span class="nv">allContent = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">filter</span> <span class="nf">(model) -&gt;</span> <span class="nx">model</span><span class="p">.</span><span class="nx">hasChanged</span><span class="p">()</span>
      <span class="nv">total = </span><span class="nx">allContent</span><span class="p">.</span><span class="nx">length</span>
      <span class="nv">errorCount = </span><span class="mi">0</span>
      <span class="nv">finished = </span><span class="kc">false</span>

      <span class="nv">recSave = </span><span class="o">-&gt;</span>
        <span class="nx">$successBar</span><span class="p">.</span><span class="nx">width</span><span class="p">(((</span><span class="nx">total</span> <span class="o">-</span> <span class="nx">allContent</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="nx">errorCount</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nx">total</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;%&#39;</span><span class="p">)</span>
        <span class="nx">$errorBar</span><span class="p">.</span><span class="nx">width</span><span class="p">((</span>  <span class="nx">errorCount</span>                               <span class="o">*</span> <span class="mi">100</span> <span class="o">/</span> <span class="nx">total</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;%&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nx">allContent</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">0</span>
          <span class="k">if</span> <span class="nx">errorCount</span> <span class="o">==</span> <span class="mi">0</span>
            <span class="nv">finished = </span><span class="kc">true</span>
            <span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">trigger</span> <span class="s">&#39;sync&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <p>Clear the dirty flag</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(model) -&gt;</span> <span class="k">delete</span> <span class="nx">model</span><span class="p">.</span><span class="nx">changed</span>
            <span class="nx">$save</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s">&#39;hide&#39;</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="nx">$alertError</span><span class="p">.</span><span class="nx">removeClass</span> <span class="s">&#39;hide&#39;</span>

        <span class="k">else</span>
          <span class="nv">model = </span><span class="nx">allContent</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
          <span class="nx">$label</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <p>Clear the changed bit since it is saved.
    delete model.changed
    saving = true; recSave()</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="nv">saving = </span><span class="nx">model</span><span class="p">.</span><span class="nx">save</span> <span class="kc">null</span><span class="p">,</span>
              <span class="nv">success: </span><span class="nx">recSave</span>
              <span class="nv">error: </span><span class="o">-&gt;</span> <span class="nx">errorCount</span> <span class="o">+=</span> <span class="mi">1</span>
          <span class="k">if</span> <span class="o">not</span> <span class="nx">saving</span>
            <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;Skipping </span><span class="si">#{</span><span class="nx">model</span><span class="p">.</span><span class="nx">id</span><span class="si">}</span><span class="s"> because it is not valid&quot;</span>
            <span class="nx">recSave</span><span class="p">()</span>

      <span class="nx">$alertError</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;hide&#39;</span><span class="p">)</span>
      <span class="nx">$saving</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;hide&#39;</span><span class="p">)</span>
      <span class="nx">$save</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s">&#39;show&#39;</span><span class="p">)</span>
      <span class="nx">recSave</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <p>Only show the 'Saving...' alert box if the save takes longer than 5 seconds</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">setTimeout</span><span class="p">(</span><span class="o">-&gt;</span>
        <span class="k">if</span> <span class="nx">total</span> <span class="o">and</span> <span class="p">(</span><span class="o">not</span> <span class="nx">finished</span> <span class="o">or</span> <span class="nx">errorCount</span><span class="p">)</span>
          <span class="nx">$save</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s">&#39;show&#39;</span><span class="p">)</span>
          <span class="nx">$alertError</span><span class="p">.</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&#39;hide&#39;</span><span class="p">)</span>
          <span class="nx">$saving</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;hide&#39;</span><span class="p">)</span>
      <span class="p">,</span> <span class="mi">5000</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <h2>Book Editing</h2>

<p>The book editor has a tree of node views (nested <code>Marionette.ContainerView</code>)
with Drag and Drop handling restricted by <code>mediaType</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">BookEditNodeView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">CompositeView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">BOOK_EDIT_NODE</span>
    <span class="nv">tagName: </span><span class="s">&#39;li&#39;</span>
    <span class="nv">events:</span>
      <span class="s">&#39;click &gt; .edit-content&#39;</span><span class="o">:</span> <span class="s">&#39;editContent&#39;</span>
      <span class="s">&#39;click &gt; .edit-settings&#39;</span><span class="o">:</span> <span class="s">&#39;editSettings&#39;</span>
      <span class="s">&#39;click &gt; .editor-expand-collapse&#39;</span><span class="o">:</span> <span class="s">&#39;toggleExpanded&#39;</span>

    <span class="nv">editContent: </span><span class="o">-&gt;</span> <span class="nx">Controller</span><span class="p">.</span><span class="nx">editModelId</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">contentId</span><span class="p">()</span>

    <span class="nv">editSettings: </span><span class="o">-&gt;</span>
      <span class="nv">contentModel = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">contentId</span><span class="p">()</span>
      <span class="nv">originalTitle = </span><span class="nx">contentModel</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;title&#39;</span>
      <span class="nv">newTitle = </span><span class="nx">prompt</span> <span class="s">&#39;Edit Title. Enter a single &quot;-&quot; to delete this node in the ToC&#39;</span><span class="p">,</span> <span class="nx">originalTitle</span>
      <span class="k">if</span> <span class="s">&#39;-&#39;</span> <span class="o">==</span> <span class="nx">newTitle</span>
        <span class="nx">@model</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">@model</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">newTitle</span> <span class="o">==</span> <span class="nx">contentModel</span><span class="o">?</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)</span>
        <span class="nx">@model</span><span class="p">.</span><span class="nx">unset</span> <span class="s">&#39;title&#39;</span>
      <span class="k">else</span> <span class="k">if</span> <span class="nx">newTitle</span>
        <span class="nx">@model</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;title&#39;</span><span class="p">,</span> <span class="nx">newTitle</span>


    <span class="nv">toggleExpanded: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>Set the expanded state silently so we don't regenerate the <code>navTreeStr</code>
(since the model changed)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@model</span><span class="p">.</span><span class="nx">set</span> <span class="s">&#39;expanded&#39;</span><span class="p">,</span> <span class="o">!</span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;expanded&#39;</span><span class="p">),</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>
      <span class="nx">@render</span><span class="p">()</span>


    <span class="nv">initialize: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>grab the child collection from the parent model
so that we can render the collection as children
of this parent node</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="vi">@collection = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">children</span>

      <span class="nx">@listenTo</span> <span class="nx">@model</span><span class="p">,</span>      <span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span>
      <span class="nx">@listenTo</span> <span class="nx">@collection</span><span class="p">,</span> <span class="s">&#39;all&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@render</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <p>If the content title changes and we have not overridden the title
rerender the node</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">contentId</span><span class="p">()</span>
        <span class="nv">contentModel = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">contentId</span><span class="p">()</span>
        <span class="nx">@listenTo</span> <span class="nx">contentModel</span><span class="p">,</span> <span class="s">&#39;change:title&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">newTitle</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@render</span><span class="p">()</span> <span class="k">if</span> <span class="o">!</span><span class="nx">@model</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;title&#39;</span>


    <span class="nv">templateHelpers: </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">contentId</span><span class="p">()</span>
        <span class="nv">content = </span><span class="nx">Models</span><span class="p">.</span><span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">contentId</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <p>Provide the original module title to view templates
if the title has not been overridden</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <p><strong>FIXME:</strong> Just make the whole Content model available via <code>.content</code>
instead of picking out the <code>title</code> and <code>mediaType</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="p">{</span>
          <span class="nv">_contentTitle: </span><span class="nx">content</span><span class="p">.</span><span class="nx">get</span> <span class="s">&#39;title&#39;</span>
          <span class="nv">_contentMediaType: </span><span class="nx">content</span><span class="p">.</span><span class="nx">mediaType</span>
        <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <p>From <code>Marionette.CompositeView</code>.
Added check to only render when model is <code>expanded</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">_renderChildren: </span><span class="o">-&gt;</span>
      <span class="k">if</span> <span class="nx">@isRendered</span> <span class="o">and</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;expanded&#39;</span><span class="p">)</span>
        <span class="nx">Marionette</span><span class="p">.</span><span class="nx">CollectionView</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">_renderChildren</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">triggerMethod</span><span class="p">(</span><span class="s">&#39;composite:collection:rendered&#39;</span><span class="p">)</span>


    <span class="nv">onRender: </span><span class="o">-&gt;</span>

      <span class="nx">@$el</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s">&#39;.organization-node,*[data-media-type]&#39;</span><span class="p">).</span><span class="nx">data</span> <span class="s">&#39;content-tree-node&#39;</span><span class="p">,</span> <span class="nx">@model</span></pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <p>Since we use jqueryui's draggable which is loaded when Aloha loads
delay until Aloha is finished loading</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">Aloha</span><span class="p">.</span><span class="nx">ready</span> <span class="o">=&gt;</span>
        <span class="nx">_EnableContentDragging</span><span class="p">(</span><span class="nx">@$el</span><span class="p">.</span><span class="nx">children</span> <span class="s">&#39;.organization-node,*[data-media-type]&#39;</span><span class="p">)</span>

        <span class="nx">@$el</span><span class="p">.</span><span class="nx">addClass</span> <span class="s">&#39;editor-drop-zone editor-drop-zone-in&#39;</span>
        <span class="nx">@$el</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">@$el</span><span class="p">.</span><span class="nx">children</span><span class="p">(</span><span class="s">&#39;.editor-drop-zone&#39;</span><span class="p">)).</span><span class="nx">droppable</span>
          <span class="nv">greedy: </span><span class="kc">true</span>
          <span class="nv">addClasses: </span><span class="kc">false</span>
          <span class="nv">accept: </span><span class="s">&#39;.organization-node,*[data-media-type]&#39;</span>
          <span class="nv">activeClass: </span><span class="s">&#39;editor-drop-zone-active&#39;</span>
          <span class="nv">hoverClass: </span><span class="s">&#39;editor-drop-zone-hover&#39;</span>
          <span class="nv">drop: </span><span class="p">(</span><span class="nx">evt</span><span class="p">,</span> <span class="nx">ui</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <p>Possible drop cases:</p>

<ul>
<li>On the node</li>
<li>Before the node</li>
<li>After the node</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">$drag = </span><span class="nx">ui</span><span class="p">.</span><span class="nx">draggable</span>
            <span class="nv">$drop = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">target</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <p>Perform all of these DOM cleanup events once jQueryUI is finished with its events</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">delay = </span><span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <p>If $drag is not a <code>li.organization-node</code> then it has a <code>*[data-media-type]</code>
and should be converted to a link inside an <code>li</code></p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nv">drag = </span><span class="nx">$drag</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;content-tree-node&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="p">{</span>
                <span class="nv">id: </span><span class="nx">$drag</span><span class="p">.</span><span class="nx">data</span> <span class="s">&#39;content-id&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <p>The title and mediaType should inherit from the actual piece of content
   title: $drag.data 'content-title'
   mediaType: $drag.data 'media-type'</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <p>Ignore if you drop on yourself or your children</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nv">testNode = </span><span class="nx">@model</span>
              <span class="k">while</span> <span class="nx">testNode</span>
                <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="nx">drag</span><span class="p">.</span><span class="nx">cid</span> <span class="o">==</span> <span class="nx">testNode</span><span class="p">.</span><span class="nx">cid</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="nx">testNode</span><span class="p">.</span><span class="nx">id</span> <span class="o">and</span> <span class="nx">drag</span><span class="p">.</span><span class="nx">id</span> <span class="o">==</span> <span class="nx">testNode</span><span class="p">.</span><span class="nx">id</span><span class="p">)</span>
                <span class="nv">testNode = </span><span class="nx">testNode</span><span class="p">.</span><span class="nx">parent</span></pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <p>Remove the item if it is a <code>BookTocNode</code></p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nx">drag</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">drag</span><span class="p">)</span> <span class="k">if</span> <span class="nx">drag</span><span class="p">.</span><span class="nx">parent</span>

              <span class="k">if</span> <span class="nx">$drop</span><span class="p">.</span><span class="nx">hasClass</span> <span class="s">&#39;editor-drop-zone-before&#39;</span>
                <span class="nv">col = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span>
                <span class="nv">index = </span><span class="nx">col</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@model</span><span class="p">)</span>
                <span class="nx">col</span><span class="p">.</span><span class="nx">add</span> <span class="nx">drag</span><span class="p">,</span> <span class="p">{</span><span class="nv">at: </span><span class="nx">index</span><span class="p">}</span>
              <span class="k">else</span> <span class="k">if</span> <span class="nx">$drop</span><span class="p">.</span><span class="nx">hasClass</span> <span class="s">&#39;editor-drop-zone-after&#39;</span>
                <span class="nv">col = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">children</span>
                <span class="nv">index = </span><span class="nx">col</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">@model</span><span class="p">)</span>
                <span class="nx">col</span><span class="p">.</span><span class="nx">add</span> <span class="nx">drag</span><span class="p">,</span> <span class="p">{</span><span class="nv">at: </span><span class="nx">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}</span>
              <span class="k">else</span> <span class="k">if</span> <span class="nx">$drop</span><span class="p">.</span><span class="nx">hasClass</span> <span class="s">&#39;editor-drop-zone-in&#39;</span>
                <span class="nx">@model</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">add</span> <span class="nx">drag</span>
              <span class="k">else</span>
                <span class="k">throw</span> <span class="s">&#39;BUG. UNKNOWN DROP CLASS&#39;</span>

            <span class="nx">setTimeout</span> <span class="nx">delay</span><span class="p">,</span> <span class="mi">100</span>

    <span class="nv">appendHtml: </span><span class="nf">(cv, iv) -&gt;</span> <span class="nx">cv</span><span class="p">.</span><span class="nx">$</span><span class="p">(</span><span class="s">&#39;ol:first&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">iv</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <p>Use this to generate HTML with extra divs for Drag-and-Drop zones.</p>

<p>To update the Book model when a <code>drop</code> occurs we convert the new DOM into
a JSON tree and set it on the model.</p>

<p><strong>FIXME:</strong> Instead of a JSON tree this Model should be implemented using a Tree-Like Collection that has a <code>.toJSON()</code> and methods like <code>.insertBefore()</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.BookEditView = </span><span class="nx">Marionette</span><span class="p">.</span><span class="nx">CompositeView</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">template: </span><span class="nx">BOOK_EDIT</span>
    <span class="nv">itemView: </span><span class="nx">BookEditNodeView</span>
    <span class="nv">itemViewContainer: </span><span class="s">&#39;&gt; nav &gt; ol&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <p>Default media type for new Content</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">contentMediaType: </span><span class="s">&#39;application/vnd.org.cnx.module&#39;</span>

    <span class="nv">events:</span>
      <span class="s">&#39;click #nav-close&#39;</span><span class="o">:</span> <span class="s">&#39;closeView&#39;</span>
      <span class="s">&#39;click #add-section&#39;</span><span class="o">:</span> <span class="s">&#39;prependSection&#39;</span>
      <span class="s">&#39;click #add-content&#39;</span><span class="o">:</span> <span class="s">&#39;prependContent&#39;</span>

    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="vi">@collection = </span><span class="nx">@model</span><span class="p">.</span><span class="nx">navTreeRoot</span><span class="p">.</span><span class="nx">children</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <p><strong>FIXME:</strong> Make the mediaType for new content a property of the view
(so the EPUB book editor can override it) or use <code>media-types</code> to look it up.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">prependSection: </span><span class="o">-&gt;</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">prependNewContent</span> <span class="p">{</span><span class="nv">title: </span><span class="s">&#39;Untitled Section&#39;</span><span class="p">}</span>
    <span class="nv">prependContent: </span><span class="o">-&gt;</span> <span class="nx">@model</span><span class="p">.</span><span class="nx">prependNewContent</span> <span class="p">{</span><span class="nv">title: </span><span class="s">&#39;Untitled Content&#39;</span><span class="p">},</span> <span class="nx">@contentMediaType</span>

    <span class="nv">closeView: </span><span class="o">-&gt;</span> <span class="nx">Controller</span><span class="p">.</span><span class="nx">hideSidebar</span><span class="p">()</span>

    <span class="nv">appendHtml: </span><span class="nf">(cv, iv, index)-&gt;</span>
      <span class="nv">$container = </span><span class="nx">@getItemViewContainer</span><span class="p">(</span><span class="nx">cv</span><span class="p">)</span>
      <span class="nv">$prevChild = </span><span class="nx">$container</span><span class="p">.</span><span class="nx">children</span><span class="p">().</span><span class="nx">eq</span><span class="p">(</span><span class="nx">index</span><span class="p">)</span>
      <span class="k">if</span> <span class="nx">$prevChild</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="nx">iv</span><span class="p">.</span><span class="nx">$el</span><span class="p">.</span><span class="nx">insertBefore</span><span class="p">(</span><span class="nx">$prevChild</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nx">$container</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">iv</span><span class="p">.</span><span class="nx">el</span><span class="p">)</span>

  <span class="k">return</span> <span class="nx">exports</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 