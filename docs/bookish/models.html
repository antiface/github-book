<!DOCTYPE html>  <html> <head>   <title>models.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="atc.html">                 atc.coffee               </a>                                           <a class="source" href="bookish.html">                 bookish.coffee               </a>                                           <a class="source" href="auth.html">                 auth.coffee               </a>                                           <a class="source" href="controller.html">                 controller.coffee               </a>                                           <a class="source" href="languages.html">                 languages.coffee               </a>                                           <a class="source" href="media-types.html">                 media-types.coffee               </a>                                           <a class="source" href="models.html">                 models.coffee               </a>                                           <a class="source" href="strings.html">                 strings.coffee               </a>                                           <a class="source" href="views.html">                 views.coffee               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               models.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <h1>Backbone Models</h1>

<p>This module contains backbone models used throughout the application</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span><span class="s">&#39;exports&#39;</span><span class="p">,</span> <span class="s">&#39;jquery&#39;</span><span class="p">,</span> <span class="s">&#39;backbone&#39;</span><span class="p">,</span> <span class="s">&#39;bookish/media-types&#39;</span><span class="p">,</span> <span class="s">&#39;i18n!bookish/nls/strings&#39;</span><span class="p">],</span> <span class="nf">(exports, jQuery, Backbone, MEDIA_TYPES, __) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Custom Models defined above are mixed in using <code>BaseContent.initialize</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">BaseModel = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>New content is given an id before it is saved so it can be added to a book.
A book can refer to a new piece of content in its Table of Contents
(which could be stored in a HTML <code>&lt;a href="[id]"/&gt;</code> tag) so it needs some <code>id</code>.</p>

<p>The Book Model can then listen to <code>change:id</code> and update the link when the
new content is saved and the id is updated.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">isNew: </span><span class="o">-&gt;</span> <span class="o">not</span> <span class="nx">@id</span> <span class="o">or</span> <span class="nx">@id</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/^_NEW:/</span><span class="p">)</span>
    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="k">throw</span> <span class="s">&#39;BUG: No mediaType set&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@mediaType</span>
      <span class="k">throw</span> <span class="s">&#39;BUG: No mediaType not registered&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">MEDIA_TYPES</span><span class="p">.</span><span class="nx">get</span> <span class="nx">@mediaType</span>
      <span class="nx">@set</span> <span class="p">{</span><span class="nv">id: </span><span class="s">&quot;_NEW:</span><span class="si">#{</span><span class="nx">@cid</span><span class="si">}</span><span class="s">&quot;</span><span class="p">}</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@id</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h1>ALL_CONTENT</h1>

<p><code>ALL_CONTENT</code> stores all Content models known to the editor and provides a
way to look up any content by <code>id</code> if needed.</p>

<p>It is also used by the <strong>Save</strong> button to decide if content has been changed.</p>

<p>It is initially declared <code>null</code> because it is used by <code>DeferrableCollection</code>
and instantiated afterwards (cyclic dependency)</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">ALL_CONTENT = </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h1>Fully loading Content</h1>

<p>A model representing a piece of content may have been instantiated
(ie an entry as a result of a search) but not fetched yet.</p>

<p>When dealing with a model (except for <code>id</code>, <code>title</code>, or <code>mediaType</code>)
be sure to call <code>.loaded().done(cb).fail(cb)</code> first.</p>

<p>Once the model is loaded (fetched) call the callbacks.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">Deferrable = </span><span class="nx">BaseModel</span><span class="p">.</span><span class="nx">extend</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Returns a promise that the piece of content will be fully populated from
the server.
Initially the content is partially populated from a Search result, folder
listing, or some other method that allowed the user to 'click' on to begin
viewing/editing the full piece of content.</p>

<p><strong>FIXME:</strong> If <code>@isNew()</code> then the Model should always be fully loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">loaded: </span><span class="nf">(flag=false) -&gt;</span>
      <span class="k">if</span> <span class="nx">flag</span> <span class="c1"># or @isNew()</span>
        <span class="nv">deferred = </span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">()</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">@</span>
        <span class="vi">@_promise = </span><span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>Mark it as loaded for the views.
By setting an attribute views can listen to a change and rerender,
replacing the progress bar with the actual view</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@set</span> <span class="p">{</span><span class="nv">_done: </span><span class="kc">true</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>Silently update the model (the user has not seen the model yet)
so <code>model.hasChanged()</code> returns <code>false</code> (to know when to enable Saving)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">@_promise</span> <span class="o">or</span> <span class="s">&#39;rejected&#39;</span> <span class="o">==</span> <span class="nx">@_promise</span><span class="p">.</span><span class="nx">state</span><span class="p">()</span>
        <span class="nx">@set</span> <span class="p">{</span><span class="nv">_loading: </span><span class="kc">true</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p><strong>TODO:</strong> Set <code>silent:true</code> during the fetch (So save doesn't trigger)
but make sure all the views listen to <code>change:_done</code> so they always update
instead of relying on <code>change:*</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@_promise = </span><span class="nx">@fetch</span> <span class="c1"># {silent:true}</span>
          <span class="nv">error: </span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">@trigger</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">options</span>
        <span class="nx">@_promise</span>
        <span class="p">.</span><span class="nx">progress</span> <span class="p">(</span><span class="nx">progress</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@set</span> <span class="p">{</span><span class="nv">_progress: </span><span class="nx">progress</span><span class="p">}</span>
        <span class="p">.</span><span class="nx">done</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Once we are done fetching and the change events have fired
clear all the <code>.changed</code> flag so save does not think it has dirty models</p>             </td>             <td class="code">               <div class="highlight"><pre>          <span class="k">delete</span> <span class="nx">@changed</span>
          <span class="nx">@set</span> <span class="p">{</span><span class="nv">_done: </span><span class="kc">true</span><span class="p">}</span>
        <span class="p">.</span><span class="nx">fail</span> <span class="p">(</span><span class="nx">error</span><span class="p">)</span> <span class="o">=&gt;</span>
          <span class="nx">@trigger</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">error</span>

      <span class="k">return</span> <span class="nx">@_promise</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Add the <code>mediaType</code> to the JSON</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">toJSON: </span><span class="o">-&gt;</span>
      <span class="nv">json = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="nv">json.mediaType = </span><span class="nx">@mediaType</span>
      <span class="k">return</span> <span class="nx">json</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Collection analog of <code>Deferrable</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">DeferrableCollection = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>This is mostly the same code in <code>Deferrable.loaded</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">loaded: </span><span class="nf">(flag) -&gt;</span>
      <span class="k">if</span> <span class="nx">flag</span>
        <span class="nv">deferred = </span><span class="nx">jQuery</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">()</span>
        <span class="nx">deferred</span><span class="p">.</span><span class="nx">resolve</span> <span class="nx">@</span>
        <span class="vi">@_promise = </span><span class="nx">deferred</span><span class="p">.</span><span class="nx">promise</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Mark it as loaded for the views</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@_done = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Silently update the model (the user has not seen the model yet)
so <code>model.hasChanged()</code> returns <code>false</code> (to know when to enable Saving)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="k">if</span> <span class="o">not</span> <span class="nx">@_promise</span> <span class="o">or</span> <span class="s">&#39;rejected&#39;</span> <span class="o">==</span> <span class="nx">@_promise</span><span class="p">.</span><span class="nx">state</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p><strong>TODO:</strong> Match the "Set <code>silent:true</code> " TODO in <code>Deferrable</code></p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="vi">@_promise = </span><span class="nx">@fetch</span> <span class="c1"># {silent:true}</span>
          <span class="nv">error: </span><span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span>
            <span class="nx">@trigger</span> <span class="s">&#39;error&#39;</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">message</span><span class="p">,</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Once we are done fetching and the change events have fired
clear all the <code>.changed</code> flag so save does not think it has dirty models</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@_promise</span><span class="p">.</span><span class="k">then</span> <span class="o">=&gt;</span> <span class="k">delete</span> <span class="nx">@changed</span>

      <span class="k">return</span> <span class="nx">@_promise</span>

    <span class="nv">toJSON: </span><span class="o">-&gt;</span> <span class="p">(</span><span class="nx">model</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="k">for</span> <span class="nx">model</span> <span class="k">in</span> <span class="nx">@models</span><span class="p">)</span>
    <span class="nv">initialize: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>When a collection is updated make sure <code>ALL_CONTENT</code> has a reference to all
the added models.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;add&#39;</span><span class="p">,</span>   <span class="nf">(model) -&gt;</span> <span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">add</span> <span class="nx">model</span>
      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;reset&#39;</span><span class="p">,</span> <span class="nf">(collection, options) -&gt;</span> <span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">add</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">toArray</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h1>All Content</h1>

<p>To prevent multiple copies of a model from floating around a single
copy of all referenced content (loaded or not) is kept in this Collection</p>

<p>This should be read-only by others
New content models should be created by calling <code>ALL_CONTENT.add {}</code></p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">AllContent = </span><span class="nx">DeferrableCollection</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">model: </span><span class="nx">BaseContent</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Override the <code>DeferrableCollection</code> initialize because this is the <code>ALL_CONTENT</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initialize: </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Never wait to fetch this collection</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@loaded</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>

  <span class="nv">ALL_CONTENT = </span><span class="k">new</span> <span class="nx">AllContent</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>When searching for text, perform a local filter on content while the search
waits for the server to respond.</p>

<p>This Collection takes another Collection and maintains an active filter on it.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">FilteredCollection = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">defaults:</span>
      <span class="nv">collection: </span><span class="kc">null</span>

    <span class="nv">setFilter: </span><span class="nf">(str) -&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">@filterStr</span> <span class="o">==</span> <span class="nx">str</span>
      <span class="vi">@filterStr = </span><span class="nx">str</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>Remove anything that no longer matches</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">models = </span><span class="p">(</span><span class="nx">@collection</span><span class="p">.</span><span class="nx">filter</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@isMatch</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span>
      <span class="nx">@reset</span> <span class="nx">models</span>

    <span class="nv">isMatch: </span><span class="nf">(model) -&gt;</span>
      <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@filterStr</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>Search inside the <code>title</code> attribute first.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">title = </span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
      <span class="nv">found = </span><span class="nx">title</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">search</span><span class="p">(</span><span class="nx">@filterStr</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">())</span> <span class="o">&gt;=</span> <span class="mi">0</span>
      <span class="k">return</span> <span class="kc">true</span> <span class="k">if</span> <span class="nx">found</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Search inside the <code>body</code> attribute if it exists,
filtering out HTML tag names and attributes.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">body = </span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
      <span class="nv">bodyText = </span><span class="nx">body</span><span class="p">.</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\&lt;(\/?[^\\&gt;]+)\\&gt;/</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\s+/</span><span class="p">,</span> <span class="s">&#39; &#39;</span><span class="p">).</span><span class="nx">trim</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p><strong>FIXME:</strong> Whoops! Add code to actually search the <code>body</code></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initialize: </span><span class="nf">(models, options) -&gt;</span>
      <span class="vi">@filterStr = </span><span class="nx">options</span><span class="p">.</span><span class="nx">filterStr</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
      <span class="vi">@collection = </span><span class="nx">options</span><span class="p">.</span><span class="nx">collection</span>
      <span class="k">throw</span> <span class="s">&#39;BUG: Cannot filter on a non-existent collection&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">@collection</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Initially add all models that match the current filter</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@add</span> <span class="p">(</span><span class="nx">@collection</span><span class="p">.</span><span class="nx">filter</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@isMatch</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>Update the filtered collection when items are added/removed</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@listenTo</span> <span class="nx">@collection</span><span class="p">,</span> <span class="s">&#39;add&#39;</span><span class="p">,</span>    <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@add</span> <span class="nx">model</span> <span class="k">if</span> <span class="nx">@isMatch</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
      <span class="nx">@listenTo</span> <span class="nx">@collection</span><span class="p">,</span> <span class="s">&#39;remove&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@remove</span> <span class="nx">model</span>
      <span class="nx">@listenTo</span> <span class="nx">@collection</span><span class="p">,</span> <span class="s">&#39;reset&#39;</span><span class="p">,</span>  <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@reset</span><span class="p">()</span>
        <span class="nx">@add</span> <span class="p">(</span><span class="nx">@collection</span><span class="p">.</span><span class="nx">filter</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@isMatch</span><span class="p">(</span><span class="nx">model</span><span class="p">))</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>If the model changes and the filter now does/does-not apply then update</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@listenTo</span> <span class="nx">@collection</span><span class="p">,</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">if</span> <span class="nx">@isMatch</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span>
          <span class="nx">@add</span> <span class="nx">model</span>
        <span class="k">else</span>
          <span class="nx">@remove</span> <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>The <code>Content</code> model contains the following members:</p>

<ul>
<li><code>title</code> - an HTML title of the content</li>
<li><code>language</code> - the main language (eg <code>en-us</code>)</li>
<li><code>subjects</code> - an array of strings (eg <code>['Mathematics', 'Business']</code>)</li>
<li><code>keywords</code> - an array of keywords (eg <code>['constant', 'boltzmann constant']</code>)</li>
<li><code>authors</code> - an <code>Collection</code> of <code>User</code>s that are attributed as authors</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">BaseContent = </span><span class="nx">Deferrable</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">mediaType: </span><span class="s">&#39;application/vnd.org.cnx.module&#39;</span>
    <span class="nv">defaults:</span>
      <span class="nv">title: </span><span class="kc">null</span>
      <span class="nv">subjects: </span><span class="p">[]</span>
      <span class="nv">keywords: </span><span class="p">[]</span>
      <span class="nv">authors: </span><span class="p">[]</span>
      <span class="nv">copyrightHolders: </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Default language for new content is the browser's language</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">language: </span><span class="p">(</span><span class="nx">navigator</span><span class="o">?</span><span class="p">.</span><span class="nx">userLanguage</span> <span class="o">or</span> <span class="nx">navigator</span><span class="o">?</span><span class="p">.</span><span class="nx">language</span> <span class="o">or</span> <span class="s">&#39;en&#39;</span><span class="p">).</span><span class="nx">toLowerCase</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>Used below to create JSON representation of model</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">Backbone_Model_toJSON = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="o">::</span><span class="nx">toJSON</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h1>Book ToC Tree Model</h1>

<p>The Book editor contains a tree (<code>BookTocTree</code>) of nested models <code>BookTocNode</code>
representing the book structure.</p>

<p>Events fire on <code>BookTocNode</code> items so their views can be updated but
<code>BookTocTree</code> can be listened to for events that "bubble up" to the root.</p>

<p>Examples include:</p>

<ul>
<li><code>add:treeNode</code> when a new node is added somewhere in the tree</li>
<li><code>remove:treeNode</code> when a node is removed somewhere in the tree</li>
<li><code>change:treeNode</code> when the title or id of a node in the tree has changed</li>
</ul>

<p>Additionally, each Node has a <code>.parent</code> that is updated when it is moved
(used by Views to remove/detach a node).</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>Represents an item in the ToC</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">BookTocNode = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Recursively include child nodes in the returned JSON</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">toJSON: </span><span class="o">-&gt;</span>
      <span class="nv">json = </span><span class="nx">Backbone_Model_toJSON</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
      <span class="nv">json.children = </span><span class="nx">@children</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span> <span class="k">if</span> <span class="nx">@children</span><span class="p">.</span><span class="nx">length</span>
      <span class="nx">json</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>Return the <code>id</code> of the corresponding Content Model represented by this node.
This is used to "look up" the original title of content if it has not been
Overridden in the book.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">contentId: </span><span class="o">-&gt;</span> <span class="nx">@id</span>

    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@trigger</span> <span class="s">&#39;change:treeNode&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>If the Tree Node is initialized with a <code>children</code> property
then use that config to recursively create new child nodes.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">children = </span><span class="nx">@get</span> <span class="s">&#39;children&#39;</span>
      <span class="nx">@unset</span> <span class="s">&#39;children&#39;</span><span class="p">,</span> <span class="p">{</span><span class="nx">silent</span><span class="o">:</span><span class="kc">true</span><span class="p">}</span>

      <span class="vi">@children = </span><span class="k">new</span> <span class="nx">BookTocNodeCollection</span><span class="p">()</span>

      <span class="nx">@children</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;add&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">child.parent = </span><span class="nx">@</span>
        <span class="nx">@trigger</span> <span class="s">&#39;add:treeNode&#39;</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">options</span>
      <span class="nx">@children</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;remove&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">child</span><span class="p">,</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="k">delete</span> <span class="nx">child</span><span class="p">.</span><span class="nx">parent</span>
        <span class="nx">@trigger</span> <span class="s">&#39;remove:treeNode&#39;</span><span class="p">,</span> <span class="nx">child</span><span class="p">,</span> <span class="nx">@</span><span class="p">,</span> <span class="nx">options</span>

      <span class="nx">@children</span><span class="p">.</span><span class="nx">add</span> <span class="nx">children</span>


  <span class="nv">BookTocNodeCollection = </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">model: </span><span class="nx">BookTocNode</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h2>Root of a Tree</h2>

<p>Events that "bubble up" the tree can be listened to on this object</p>

<p>Additionally, it contains a <code>Backbone.Collection</code> of <code>descendants</code> which
contains all nodes in the tree (That's how the events "bubble up").</p>

<p>The Model can be thought of as a <code>&lt;ul&gt;</code> since it does not contain
any interesting fields itself except for <code>children</code>.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">BookTocTree = </span><span class="nx">BookTocNode</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">toJSON: </span><span class="o">-&gt;</span> <span class="nx">@children</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>

    <span class="nv">initialize: </span><span class="o">-&gt;</span>
      <span class="nx">BookTocNode</span><span class="o">::</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">@</span><span class="p">)</span>
      <span class="vi">@descendants = </span><span class="k">new</span> <span class="nx">BookTocNodeCollection</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>Populate the descendants collection</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">recDescendants = </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@descendants</span><span class="p">.</span><span class="nx">add</span> <span class="nx">node</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(child) -&gt;</span> <span class="nx">recDescendants</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span>

      <span class="nx">@children</span><span class="p">.</span><span class="nx">each</span> <span class="nf">(child) -&gt;</span> <span class="nx">recDescendants</span><span class="p">(</span><span class="nx">child</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>These events are created when someone adds to <code>BookTocNode.children</code>
And fired from the <code>BookTocNode</code></p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@descendants</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;add:treeNode&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@descendants</span><span class="p">.</span><span class="nx">add</span> <span class="nx">node</span>
        <span class="nx">@trigger</span> <span class="s">&#39;add:treeNode&#39;</span><span class="p">,</span> <span class="nx">node</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p><strong>TODO:</strong> I think this one does not work because the node is removed
from the collection before the event bubbles up so it does not bubble up</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@descendants</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;remove:treeNode&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@descendants</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">node</span>
        <span class="nx">@trigger</span> <span class="s">&#39;remove:treeNode&#39;</span><span class="p">,</span> <span class="nx">node</span>

      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;add:treeNode&#39;</span><span class="p">,</span>    <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@descendants</span><span class="p">.</span><span class="nx">add</span> <span class="nx">node</span>
      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;remove:treeNode&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@descendants</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">node</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>When the whole tree needs to be reset call this.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">reset: </span><span class="nf">(nodes) -&gt;</span>
      <span class="nx">@descendants</span><span class="p">.</span><span class="nx">reset</span><span class="p">()</span>
      <span class="nx">@children</span><span class="p">.</span><span class="nx">reset</span> <span class="nx">nodes</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>recursively add nodes to the descendants</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">recAddDescendants = </span><span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@descendants</span><span class="p">.</span><span class="nx">add</span> <span class="nx">node</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">recAddDescendants</span> <span class="nx">child</span>

      <span class="nx">@children</span><span class="p">.</span><span class="nx">each</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nv">child.parent = </span><span class="nx">@</span><span class="p">;</span> <span class="nx">recAddDescendants</span> <span class="nx">child</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h1>BaseBook (Connexions Collection)</h1>

<p>Represents a "collection" in <a href="http://cnx.org">Connexions</a> terminology and an <code>.opf</code> file in an EPUB</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">BaseBook = </span><span class="nx">Deferrable</span><span class="p">.</span><span class="nx">extend</span>
    <span class="nv">mediaType: </span><span class="s">&#39;application/vnd.org.cnx.collection&#39;</span>
    <span class="nv">defaults:</span>
      <span class="nv">manifest: </span><span class="kc">null</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>Subclasses can provide a better Collection for storing Content items in a book
so the book can listen to changes.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">manifestType: </span><span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p><strong>FIXME:</strong> Adding the <code>navTreeRoot</code> should probably be removed since the views are recursive
and never need the entire JSON</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">toJSON: </span><span class="o">-&gt;</span>
      <span class="nv">json = </span><span class="nx">Deferrable</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span><span class="nx">@</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">)</span>
      <span class="nv">json.navTree = </span><span class="nx">@navTreeRoot</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">()</span>
      <span class="k">return</span> <span class="nx">json</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>Takes an element representing a <code>&lt;nav epub:type="toc"/&gt;</code> element
and returns a JSON tree with the following structure:</p>

<pre><code>[
  {id: 'path/to/file1.html', title: 'Appendix', children: [...] },
  {title: 'Unit 3', class: 'unit', children: [...] }
]
</code></pre>

<p>See <a href="http://idpf.org/epub/30/spec/epub30-contentdocs.html#sec-xhtml-nav-def-types-toc">The toc nav Element</a> for more information.</p>

<p>This method is also used by the DnD edit view.</p>

<p>Example from an ePUB3:</p>

<pre><code>&lt;nav epub:type="toc"&gt;
  &lt;ol&gt;
    &lt;li&gt;&lt;a href="path/to/file1.html"&gt;Appendix&lt;/a&gt;&lt;/li&gt;
    &lt;li class="unit"&gt;&lt;span&gt;Unit 3&lt;/span&gt;&lt;ol&gt;[...]&lt;/ol&gt;&lt;/li&gt;
  &lt;/ol&gt;
&lt;/nav&gt;
</code></pre>

<p>Example from the Drag-and-Drop Book editor (Tree View):</p>

<pre><code>&lt;div&gt;
  &lt;ol&gt;
    &lt;li&gt;&lt;span data-id="path/to/file1.html"&gt;Appendix&lt;/a&gt;&lt;/li&gt;
    &lt;li class="unit"&gt;&lt;span&gt;Unit 3&lt;/span&gt;&lt;ol&gt;[...]&lt;/ol&gt;&lt;/li&gt;
  &lt;/ol&gt;
&lt;/nav&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">parseNavTree: </span><span class="nf">(li) -&gt;</span>
      <span class="nv">$li = </span><span class="nx">jQuery</span><span class="p">(</span><span class="nx">li</span><span class="p">)</span>

      <span class="nv">$a = </span><span class="nx">$li</span><span class="p">.</span><span class="nx">children</span> <span class="s">&#39;a, span&#39;</span>
      <span class="nv">$ol = </span><span class="nx">$li</span><span class="p">.</span><span class="nx">children</span> <span class="s">&#39;ol&#39;</span>

      <span class="nv">obj = </span><span class="p">{</span><span class="nv">id: </span><span class="nx">$a</span><span class="p">.</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;href&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">$a</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)}</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>Don't set the title if we have not overridden it</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">obj.title = </span><span class="nx">$a</span><span class="p">.</span><span class="nx">text</span><span class="p">()</span> <span class="k">if</span> <span class="o">!</span><span class="nx">$a</span><span class="p">.</span><span class="nx">hasClass</span> <span class="s">&#39;autogenerated-text&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <p>The custom class is either set on the <code>$span</code> (if parsing from the editor) or on the <code>$a</code> (if parsing from an EPUB)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">obj.class = </span><span class="nx">$a</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">$a</span><span class="p">.</span><span class="o">not</span><span class="p">(</span><span class="s">&#39;span&#39;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s">&#39;class&#39;</span><span class="p">)</span>

      <span class="nv">obj.children = </span><span class="p">(</span><span class="nx">@parseNavTree</span><span class="p">(</span><span class="nx">li</span><span class="p">)</span> <span class="k">for</span> <span class="nx">li</span> <span class="k">in</span> <span class="nx">$ol</span><span class="p">.</span><span class="nx">children</span><span class="p">())</span> <span class="k">if</span> <span class="nx">$ol</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">return</span> <span class="nx">obj</span></pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Creates a Manifest collection of all content it should listen to.</p>

<p>For example, changes to <code>id</code> or <code>title</code> of a piece of content will update the navigation tree.</p>

<p>Similarly, an update to the navigation tree will create new models.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initialize: </span><span class="o">-&gt;</span>

      <span class="vi">@manifest = </span><span class="k">new</span> <span class="nx">@manifestType</span><span class="p">()</span>
      <span class="vi">@navTreeRoot = </span><span class="k">new</span> <span class="nx">BookTocTree</span><span class="p">()</span>

      <span class="nx">@listenTo</span> <span class="nx">@manifest</span><span class="p">,</span> <span class="s">&#39;add&#39;</span><span class="p">,</span>   <span class="nf">(model, collection) -&gt;</span> <span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">add</span> <span class="nx">model</span>
      <span class="nx">@listenTo</span> <span class="nx">@manifest</span><span class="p">,</span> <span class="s">&#39;reset&#39;</span><span class="p">,</span> <span class="nf">(model, collection) -&gt;</span> <span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">add</span> <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>If a model's id changes then update the <code>navTree</code> (it was a new model that got saved)</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@listenTo</span> <span class="nx">@manifest</span><span class="p">,</span> <span class="s">&#39;change:id&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">model</span><span class="p">,</span> <span class="nx">newValue</span><span class="p">,</span> <span class="nx">oldValue</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nv">node = </span><span class="nx">@navTreeRoot</span><span class="p">.</span><span class="nx">descendants</span><span class="p">.</span><span class="nx">get</span> <span class="nx">oldValue</span>
        <span class="k">return</span> <span class="nx">console</span><span class="p">.</span><span class="nx">error</span> <span class="s">&#39;BUG: There is an entry in the tree but no corresponding model in the manifest&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">node</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">,</span> <span class="nx">newValue</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>If a piece of content is linked to in the navigation document
always include it in the manifest</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@listenTo</span> <span class="nx">@navTreeRoot</span><span class="p">,</span> <span class="s">&#39;add:treeNode&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">navNode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@manifest</span><span class="p">.</span><span class="nx">add</span> <span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">navNode</span><span class="p">.</span><span class="nx">contentId</span><span class="p">())</span>
      <span class="nx">@listenTo</span> <span class="nx">@navTreeRoot</span><span class="p">,</span> <span class="s">&#39;remove:treeNode&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">navNode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@manifest</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">navNode</span><span class="p">.</span><span class="nx">contentId</span><span class="p">())</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>Trigger a change so <code>save</code> works</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">@listenTo</span> <span class="nx">@navTreeRoot</span><span class="p">,</span> <span class="s">&#39;add:treeNode&#39;</span><span class="p">,</span>    <span class="p">(</span><span class="nx">navNode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@trigger</span> <span class="s">&#39;add:treeNode&#39;</span><span class="p">,</span> <span class="nx">@</span>
      <span class="nx">@listenTo</span> <span class="nx">@navTreeRoot</span><span class="p">,</span> <span class="s">&#39;remove:treeNode&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">navNode</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">@trigger</span> <span class="s">&#39;remove:treeNode&#39;</span><span class="p">,</span> <span class="nx">@</span>
      <span class="nx">@listenTo</span> <span class="nx">@navTreeRoot</span><span class="p">,</span> <span class="s">&#39;change:treeNode&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">navNode</span><span class="p">)</span> <span class="o">=&gt;</span>
        <span class="nx">@trigger</span> <span class="s">&#39;change:treeNode&#39;</span><span class="p">,</span> <span class="nx">@</span>
        <span class="nx">@trigger</span> <span class="s">&#39;change&#39;</span><span class="p">,</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>Do this last so <code>.toJSON()</code> has the <code>navTreeRoot</code> already initialized</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">add</span> <span class="nx">@</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>Used by <code>MEDIA_TYPES.get(...).accepts</code> to add new content when content
is dropped on the book in the Workspace/Search Results views.</p>

<p>Convenience method for <code>.navTreeRoot.children.add {id: model.get('id')}, {at: 0}</code></p>

<p><strong>FIXME:</strong> Somewhat hacky way of creating a new piece of content (remove the <code>mediaType</code> arg)</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">prependNewContent: </span><span class="nf">(model, mediaType) -&gt;</span>
      <span class="k">if</span> <span class="nx">model</span> <span class="k">instanceof</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>If the model is already in the book then do not add it again</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">return</span> <span class="k">if</span> <span class="nx">@manifest</span><span class="p">.</span><span class="nx">get</span> <span class="nx">model</span><span class="p">.</span><span class="nx">id</span>

        <span class="nx">@manifest</span><span class="p">.</span><span class="nx">add</span> <span class="nx">model</span>

      <span class="k">else</span> <span class="k">if</span> <span class="nx">mediaType</span>
        <span class="nv">config = </span><span class="nx">model</span>
        <span class="k">throw</span> <span class="s">&#39;BUG: Media type not registered&#39;</span> <span class="k">if</span> <span class="o">not</span> <span class="nx">MEDIA_TYPES</span><span class="p">.</span><span class="nx">get</span> <span class="nx">mediaType</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Create the model from a config and add it to the manifest</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">ContentType = </span><span class="nx">MEDIA_TYPES</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">mediaType</span><span class="p">).</span><span class="nx">constructor</span>
        <span class="nv">model = </span><span class="k">new</span> <span class="nx">ContentType</span> <span class="nx">config</span>
        <span class="nx">ALL_CONTENT</span><span class="p">.</span><span class="nx">add</span> <span class="nx">model</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>Mark it as sync'd so we don't try to fetch a non-existent file
<strong>FIXME:</strong> Have <code>Deferred.loaded()</code> use <code>Model.isNew()</code> to decide if the Model is fully loaded.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">model</span><span class="p">.</span><span class="nx">loaded</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>@manifest.add model</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">console</span><span class="p">.</span><span class="nx">warn</span> <span class="s">&#39;FIXME: Hack for new content&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>Prepend to the navTree</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@navTreeRoot</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">add</span> <span class="p">{</span><span class="nv">id: </span><span class="nx">model</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">)},</span> <span class="p">{</span><span class="nv">at: </span><span class="mi">0</span><span class="p">}</span>

      <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>Otherwise, just add a container</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">@navTreeRoot</span><span class="p">.</span><span class="nx">children</span><span class="p">.</span><span class="nx">add</span> <span class="p">{</span><span class="nv">title: </span><span class="nx">model</span><span class="p">.</span><span class="nx">title</span><span class="p">},</span> <span class="p">{</span><span class="nv">at: </span><span class="mi">0</span><span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>Compare by <code>mediaType</code> (Collections/Books 1st), then by title/URL</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">CONTENT_COMPARATOR = </span><span class="nf">(a, b) -&gt;</span>
    <span class="nv">A = </span><span class="nx">a</span><span class="p">.</span><span class="nx">mediaType</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
    <span class="nv">B = </span><span class="nx">b</span><span class="p">.</span><span class="nx">mediaType</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">B</span> <span class="o">&lt;</span> <span class="nx">A</span>
    <span class="k">return</span> <span class="mi">1</span>  <span class="k">if</span> <span class="nx">A</span> <span class="o">&lt;</span> <span class="nx">B</span>

    <span class="nv">A = </span><span class="nx">a</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">a</span><span class="p">.</span><span class="nx">id</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
    <span class="nv">B = </span><span class="nx">b</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s">&#39;title&#39;</span><span class="p">)</span> <span class="o">or</span> <span class="nx">b</span><span class="p">.</span><span class="nx">id</span> <span class="o">or</span> <span class="s">&#39;&#39;</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="k">if</span> <span class="nx">B</span> <span class="o">&lt;</span> <span class="nx">A</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>  <span class="k">if</span> <span class="nx">A</span> <span class="o">&lt;</span> <span class="nx">B</span>

    <span class="k">return</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>Finally, export only the pieces needed</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.FilteredCollection = </span><span class="nx">FilteredCollection</span>
  <span class="nv">exports.BaseContent = </span><span class="nx">BaseContent</span>
  <span class="nv">exports.BaseBook = </span><span class="nx">BaseBook</span>
  <span class="nv">exports.BookTocTree = </span><span class="nx">BookTocTree</span>
  <span class="nv">exports.Deferrable = </span><span class="nx">Deferrable</span>
  <span class="nv">exports.DeferrableCollection = </span><span class="nx">DeferrableCollection</span>
  <span class="nv">exports.ALL_CONTENT = </span><span class="nx">ALL_CONTENT</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <p><strong>FIXME:</strong> Remove the next line</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.MEDIA_TYPES = </span><span class="nx">MEDIA_TYPES</span>
  <span class="nv">exports.CONTENT_COMPARATOR = </span><span class="nx">CONTENT_COMPARATOR</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <p>Other implementations can override this</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">exports.WORKSPACE = </span><span class="nx">ALL_CONTENT</span>
  <span class="k">return</span> <span class="nx">exports</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 